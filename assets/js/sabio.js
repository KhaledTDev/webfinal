// sabio.js - JavaScript espec√≠fico para la p√°gina sabio.html
// PRIORIDAD ABSOLUTA - Este script controla sabio.html

// Flag para indicar que sabio.js est√° en control (solo en sabio.html)
window.SABIO_PAGE_ACTIVE = window.location.pathname.includes('sabio.html');

// Estado global para la p√°gina del sabio
const SabioPageState = {
  selectedSabio: null,
  sabioInfo: null,
  activeCategory: 'all', // Categor√≠a "Todo" activa por defecto
  currentContent: [],
  appJsInitialized: false,
  activeNav: null // Track navigation state (favorites, categories, home)
};

// Funci√≥n para prevenir que app.js interfiera con sabio.html
// PERMITIR: search, audio manager, y funciones de navegaci√≥n esenciales
function preventAppJsInterference() {
  console.log('Setting up sabio.js priority - blocking app.js category/content functions but allowing navigation');
  
  // BLOQUEAR: Funciones de contenido y categor√≠as de app.js
  if (window.loadHomePage) {
    const originalLoadHomePage = window.loadHomePage;
    window.loadHomePage = function() {
      if (window.SABIO_PAGE_ACTIVE) {
        console.log('BLOCKED: app.js loadHomePage on sabio.html');
        return;
      }
      return originalLoadHomePage.apply(this, arguments);
    };
  }
  
  if (window.renderHomeContent) {
    const originalRenderHomeContent = window.renderHomeContent;
    window.renderHomeContent = function() {
      if (window.SABIO_PAGE_ACTIVE) {
        console.log('BLOCKED: app.js renderHomeContent on sabio.html');
        return;
      }
      return originalRenderHomeContent.apply(this, arguments);
    };
  }
  
  if (window.renderContent) {
    const originalRenderContent = window.renderContent;
    window.renderContent = function() {
      if (window.SABIO_PAGE_ACTIVE) {
        // Permitir renderContent para p√°ginas espec√≠ficas de navegaci√≥n
        const activeNav = window.AppState ? window.AppState.activeNav : null;
        console.log(`DEBUG: AppState exists: ${!!window.AppState}, activeNav: ${activeNav}`);
        
        if (activeNav === 'categories' || activeNav === 'favorites') {
          console.log(`‚úÖ ALLOWED: app.js renderContent for navigation page: ${activeNav}`);
          return originalRenderContent.apply(this, arguments);
        }
        
        // Tambi√©n permitir si no hay AppState (para compatibilidad)
        if (!window.AppState) {
          console.log('‚ö†Ô∏è AppState not found, allowing renderContent for compatibility');
          return originalRenderContent.apply(this, arguments);
        }
        
        console.log(`BLOCKED: app.js renderContent on sabio.html (activeNav: ${activeNav})`);
        return;
      }
      return originalRenderContent.apply(this, arguments);
    };
  }
  
  // BLOQUEAR: Funciones de categor√≠as de app.js
  if (window.loadCategoryContent) {
    const originalLoadCategoryContent = window.loadCategoryContent;
    window.loadCategoryContent = function() {
      if (window.SABIO_PAGE_ACTIVE) {
        console.log('BLOCKED: app.js loadCategoryContent on sabio.html - using sabio.js version');
        return;
      }
      return originalLoadCategoryContent.apply(this, arguments);
    };
  }
  
  if (window.filterByType) {
    const originalFilterByType = window.filterByType;
    window.filterByType = function() {
      if (window.SABIO_PAGE_ACTIVE) {
        console.log('BLOCKED: app.js filterByType on sabio.html');
        return;
      }
      return originalFilterByType.apply(this, arguments);
    };
  }
  
  if (window.renderContentCard) {
    const originalRenderContentCard = window.renderContentCard;
    window.renderContentCard = function() {
      if (window.SABIO_PAGE_ACTIVE) {
        // Allow renderContentCard for favorites rendering
        const stack = new Error().stack;
        if (stack && (stack.includes('renderFavoriteCards') || stack.includes('renderFavoritesPage'))) {
          console.log('‚úÖ ALLOWED: app.js renderContentCard for favorites rendering');
          return originalRenderContentCard.apply(this, arguments);
        }
        
        // Also allow if we're in favorites navigation context
        if (window.SabioPageState && window.SabioPageState.activeNav === 'favorites') {
          console.log('‚úÖ ALLOWED: app.js renderContentCard for favorites navigation');
          return originalRenderContentCard.apply(this, arguments);
        }
        
        console.log('BLOCKED: app.js renderContentCard on sabio.html - using sabio.js version');
        return;
      }
      return originalRenderContentCard.apply(this, arguments);
    };
  }
  
  // PERMITIR EXPL√çCITAMENTE: Funciones de navegaci√≥n esenciales
  console.log('‚úÖ ALLOWED: Navigation functions from app.js:');
  
  // Permitir funciones de men√∫ m√≥vil
  if (window.toggleMobileMenu) {
    console.log('  - toggleMobileMenu (mobile menu)');
  }
  if (window.closeMobileMenu) {
    console.log('  - closeMobileMenu (mobile menu)');
  }
  
  // Permitir funciones de b√∫squeda
  if (window.performSearch) {
    console.log('  - performSearch (search functionality)');
  }
  
  // Permitir funciones de reproductor de audio
  if (window.handleMediaClick) {
    console.log('  - handleMediaClick (audio player)');
  }
  if (window.togglePlayPause) {
    console.log('  - togglePlayPause (audio player)');
  }
  if (window.playNext) {
    console.log('  - playNext (audio player)');
  }
  if (window.playPrevious) {
    console.log('  - playPrevious (audio player)');
  }
  if (window.toggleQueue) {
    console.log('  - toggleQueue (audio player)');
  }
  if (window.clearQueue) {
    console.log('  - clearQueue (audio player)');
  }
  if (window.closeAudioPlayer) {
    console.log('  - closeAudioPlayer (audio player)');
  }
  
  // Permitir funciones de favoritos (si las necesitamos)
  if (window.toggleFavorite) {
    console.log('  - toggleFavorite (favorites system)');
  }
  
  // Permitir funciones de video
  if (window.showVideoPlayer) {
    console.log('  - showVideoPlayer (video player)');
  }
  if (window.closeVideoPlayer) {
    console.log('  - closeVideoPlayer (video player)');
  }
  
  // Permitir funciones del mega men√∫ de sabios
  if (window.toggleMegaMenu) {
    console.log('  - toggleMegaMenu (sabios mega menu)');
  }
  if (window.closeMegaMenu) {
    console.log('  - closeMegaMenu (sabios mega menu)');
  }
  if (window.navigateToSabio) {
    console.log('  - navigateToSabio (sabio navigation)');
  }
  
  console.log('‚ùå BLOCKED: Content rendering and category functions from app.js');
}

// Funci√≥n para obtener informaci√≥n del sabio
async function loadSabioInfo(sabioName) {
  console.log(`Loading sabio info for: "${sabioName}"`);
  console.log(`üîç Sabio name details:`, {
    original: sabioName,
    encoded: encodeURIComponent(sabioName),
    length: sabioName.length,
    charCodes: sabioName.split('').map(c => c.charCodeAt(0))
  });
  
  try {
    const url = `assets/php/sabio_loader.php?action=get_sabio_info&sabio=${encodeURIComponent(sabioName)}`;
    console.log(`üì° Fetching sabio info URL: ${url}`);
    
    const response = await fetch(url);
    console.log(`üì° Response status: ${response.status} ${response.statusText}`);
    
    const responseText = await response.text();
    console.log(`üì° Raw response text:`, responseText);
    
    let data;
    try {
      data = JSON.parse(responseText);
    } catch (parseError) {
      console.error('‚ùå JSON parse error:', parseError);
      console.error('‚ùå Response text that failed to parse:', responseText);
      throw new Error('Invalid JSON response from server');
    }
    
    console.log('üì¶ Parsed sabio info response:', data);
    
    if (data.success) {
      console.log('‚úÖ Sabio info loaded successfully:');
      console.log('Sabio name:', data.data.name);
      console.log('üñºÔ∏è Image:', data.data.image);
      console.log('Stats:', data.data.stats);
      console.log('Categories count:', data.data.stats.categories);
      
      // Verificar si las categor√≠as tienen archivos
      Object.entries(data.data.stats.categories).forEach(([category, count]) => {
        if (count > 0) {
          console.log(`‚úÖ Category "${category}" has ${count} files`);
        } else {
          console.warn(`‚ö†Ô∏è Category "${category}" has NO files (count: ${count})`);
        }
      });
      
      return data.data;
    } else {
      console.error('‚ùå PHP returned error:', data.message || data.error);
      throw new Error(data.message || data.error || 'Failed to load sabio info');
    }
  } catch (error) {
    console.error('üí• Error loading sabio info:', error);
    console.log('üîÑ Using fallback sabio data for testing...');
    
    // FALLBACK DATA para pruebas
    const fallbackData = {
      name: sabioName,
      image: null,
      stats: {
        total_audio: 38,
        total_pdf: 5,
        categories: {
          duruz: 30,
          firak: 8,
          pdf: 5
        }
      }
    };
    
    console.log('‚úÖ Using fallback sabio data:', fallbackData);
    return fallbackData;
  }
}

// Funci√≥n para obtener contenido del sabio por categor√≠a
async function loadSabioContent(sabioName, category) {
  console.log(`Loading content for sabio: "${sabioName}", category: "${category}"`);
  
  try {
    const url = `assets/php/sabio_loader.php?action=get_sabio_content&sabio=${encodeURIComponent(sabioName)}&category=${encodeURIComponent(category)}`;
    console.log(`üì° Fetching URL: ${url}`);
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('üì¶ Raw response from PHP:', data);
    
    if (data.success) {
      console.log(`‚úÖ Successfully loaded ${data.data.total} files for category "${category}"`);
      console.log('Files data:', data.data.files);
      return data.data;
    } else {
      console.error('‚ùå PHP returned error:', data.message);
      throw new Error(data.message || 'Failed to load sabio content');
    }
  } catch (error) {
    console.error('üí• Error loading sabio content:', error);
    console.log('üîÑ Using fallback content data for testing...');
    
    // FALLBACK DATA para pruebas
    const fallbackFiles = {
      duruz: [
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ™Ÿàÿ≠ŸäÿØ ÿßŸÑÿ£ŸàŸÑ', filename: 'lesson1.mp3', path: '#', size: 5000000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ™Ÿàÿ≠ŸäÿØ ÿßŸÑÿ´ÿßŸÜŸä', filename: 'lesson2.mp3', path: '#', size: 6000000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿµŸÑÿßÿ©', filename: 'lesson3.mp3', path: '#', size: 4500000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ≤ŸÉÿßÿ© ÿßŸÑÿ£ŸàŸÑ', filename: 'lesson4.mp3', path: '#', size: 5500000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ≤ŸÉÿßÿ© ÿßŸÑÿ´ÿßŸÜŸä', filename: 'lesson5.mp3', path: '#', size: 6200000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿµŸäÿßŸÖ ÿßŸÑÿ£ŸàŸÑ', filename: 'lesson6.mp3', path: '#', size: 4800000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿµŸäÿßŸÖ ÿßŸÑÿ´ÿßŸÜŸä', filename: 'lesson7.mp3', path: '#', size: 5200000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ≠ÿ¨ ÿßŸÑÿ£ŸàŸÑ', filename: 'lesson8.mp3', path: '#', size: 6800000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ≠ÿ¨ ÿßŸÑÿ´ÿßŸÜŸä', filename: 'lesson9.mp3', path: '#', size: 5900000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ≠ÿ¨ ÿßŸÑÿ´ÿßŸÑÿ´', filename: 'lesson10.mp3', path: '#', size: 6100000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ∑Ÿáÿßÿ±ÿ© ÿßŸÑÿ£ŸàŸÑ', filename: 'lesson11.mp3', path: '#', size: 4700000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ∑Ÿáÿßÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸä', filename: 'lesson12.mp3', path: '#', size: 5300000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ∑Ÿáÿßÿ±ÿ© ÿßŸÑÿ´ÿßŸÑÿ´', filename: 'lesson13.mp3', path: '#', size: 5800000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑŸàÿ∂Ÿàÿ° ÿßŸÑÿ£ŸàŸÑ', filename: 'lesson14.mp3', path: '#', size: 4400000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑŸàÿ∂Ÿàÿ° ÿßŸÑÿ´ÿßŸÜŸä', filename: 'lesson15.mp3', path: '#', size: 4900000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ∫ÿ≥ŸÑ ÿßŸÑÿ£ŸàŸÑ', filename: 'lesson16.mp3', path: '#', size: 5600000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ∫ÿ≥ŸÑ ÿßŸÑÿ´ÿßŸÜŸä', filename: 'lesson17.mp3', path: '#', size: 5100000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ™ŸäŸÖŸÖ', filename: 'lesson18.mp3', path: '#', size: 4600000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿ£ÿ≠ŸÉÿßŸÖ ÿßŸÑŸÖŸäÿßŸá', filename: 'lesson19.mp3', path: '#', size: 5400000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑŸÜÿ¨ÿßÿ≥ÿßÿ™', filename: 'lesson20.mp3', path: '#', size: 4300000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿ£ŸàŸÇÿßÿ™ ÿßŸÑÿµŸÑÿßÿ©', filename: 'lesson21.mp3', path: '#', size: 5700000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑŸÇÿ®ŸÑÿ©', filename: 'lesson22.mp3', path: '#', size: 4200000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ£ÿ∞ÿßŸÜ', filename: 'lesson23.mp3', path: '#', size: 4800000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿßŸÑÿ•ŸÇÿßŸÖÿ©', filename: 'lesson24.mp3', path: '#', size: 3900000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿ¥ÿ±Ÿàÿ∑ ÿßŸÑÿµŸÑÿßÿ©', filename: 'lesson25.mp3', path: '#', size: 6300000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿ£ÿ±ŸÉÿßŸÜ ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑÿ£ŸàŸÑ', filename: 'lesson26.mp3', path: '#', size: 5500000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿ£ÿ±ŸÉÿßŸÜ ÿßŸÑÿµŸÑÿßÿ© ÿßŸÑÿ´ÿßŸÜŸä', filename: 'lesson27.mp3', path: '#', size: 5800000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä Ÿàÿßÿ¨ÿ®ÿßÿ™ ÿßŸÑÿµŸÑÿßÿ©', filename: 'lesson28.mp3', path: '#', size: 5200000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ÿ≥ŸÜŸÜ ÿßŸÑÿµŸÑÿßÿ©', filename: 'lesson29.mp3', path: '#', size: 4700000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' },
        { name: 'ÿØÿ±ÿ≥ ŸÅŸä ŸÖŸÉÿ±ŸàŸáÿßÿ™ ÿßŸÑÿµŸÑÿßÿ©', filename: 'lesson30.mp3', path: '#', size: 4500000, extension: 'mp3', type: 'audio', categoryLabel: 'ÿØÿ±Ÿàÿ≥' }
      ],
      firak: [
        { name: 'ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿßŸÑÿÆŸàÿßÿ±ÿ¨ ÿßŸÑÿ£ŸàŸÑ', filename: 'firak1.mp3', path: '#', size: 7000000, extension: 'mp3', type: 'audio', categoryLabel: 'ŸÅÿ±ŸÇ' },
        { name: 'ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿßŸÑŸÖÿπÿ™ÿ≤ŸÑÿ©', filename: 'firak2.mp3', path: '#', size: 5500000, extension: 'mp3', type: 'audio', categoryLabel: 'ŸÅÿ±ŸÇ' },
        { name: 'ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ÿ¥ÿßÿπÿ±ÿ© ÿßŸÑÿ£ŸàŸÑ', filename: 'firak3.mp3', path: '#', size: 6800000, extension: 'mp3', type: 'audio', categoryLabel: 'ŸÅÿ±ŸÇ' },
        { name: 'ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿßŸÑÿ£ÿ¥ÿßÿπÿ±ÿ© ÿßŸÑÿ´ÿßŸÜŸä', filename: 'firak4.mp3', path: '#', size: 6200000, extension: 'mp3', type: 'audio', categoryLabel: 'ŸÅÿ±ŸÇ' },
        { name: 'ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿßŸÑŸÖÿßÿ™ÿ±ŸäÿØŸäÿ©', filename: 'firak5.mp3', path: '#', size: 5900000, extension: 'mp3', type: 'audio', categoryLabel: 'ŸÅÿ±ŸÇ' },
        { name: 'ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿßŸÑÿ¨ŸáŸÖŸäÿ©', filename: 'firak6.mp3', path: '#', size: 6400000, extension: 'mp3', type: 'audio', categoryLabel: 'ŸÅÿ±ŸÇ' },
        { name: 'ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿßŸÑŸÇÿØÿ±Ÿäÿ©', filename: 'firak7.mp3', path: '#', size: 5800000, extension: 'mp3', type: 'audio', categoryLabel: 'ŸÅÿ±ŸÇ' },
        { name: 'ÿßŸÑÿ±ÿØ ÿπŸÑŸâ ÿßŸÑŸÖÿ±ÿ¨ÿ¶ÿ©', filename: 'firak8.mp3', path: '#', size: 6100000, extension: 'mp3', type: 'audio', categoryLabel: 'ŸÅÿ±ŸÇ' }
      ],
      pdf: [
        { name: 'ŸÉÿ™ÿßÿ® ÿßŸÑÿ™Ÿàÿ≠ŸäÿØ', filename: 'book1.pdf', path: '#', size: 2000000, extension: 'pdf', type: 'document', categoryLabel: 'ŸÉÿ™ÿßÿ®' },
        { name: 'ŸÉÿ™ÿßÿ® ŸÉÿ¥ŸÅ ÿßŸÑÿ¥ÿ®Ÿáÿßÿ™', filename: 'book2.pdf', path: '#', size: 1800000, extension: 'pdf', type: 'document', categoryLabel: 'ŸÉÿ™ÿßÿ®' },
        { name: 'ŸÉÿ™ÿßÿ® ÿßŸÑÿ£ÿµŸàŸÑ ÿßŸÑÿ´ŸÑÿßÿ´ÿ©', filename: 'book3.pdf', path: '#', size: 1200000, extension: 'pdf', type: 'document', categoryLabel: 'ŸÉÿ™ÿßÿ®' },
        { name: 'ŸÉÿ™ÿßÿ® ÿßŸÑŸÇŸàÿßÿπÿØ ÿßŸÑÿ£ÿ±ÿ®ÿπ', filename: 'book4.pdf', path: '#', size: 900000, extension: 'pdf', type: 'document', categoryLabel: 'ŸÉÿ™ÿßÿ®' },
        { name: 'ŸÉÿ™ÿßÿ® ÿßŸÑÿπŸÇŸäÿØÿ© ÿßŸÑŸàÿßÿ≥ÿ∑Ÿäÿ©', filename: 'book5.pdf', path: '#', size: 2200000, extension: 'pdf', type: 'document', categoryLabel: 'ŸÉÿ™ÿßÿ®' }
      ]
    };
    
    const categoryFiles = fallbackFiles[category] || [];
    const fallbackData = {
      sabio: sabioName,
      category: category,
      files: categoryFiles,
      total: categoryFiles.length
    };
    
    console.log('‚úÖ Using fallback content data:', fallbackData);
    return fallbackData;
  }
}

// Renderizar la informaci√≥n principal del sabio
function renderSabioHero(sabioInfo) {
  if (!sabioInfo) return '';
  
  const totalFiles = sabioInfo.stats.total_audio + sabioInfo.stats.total_pdf;
  
  // Calcular estad√≠sticas adicionales para que sea id√©ntico a index.html
  const totalCategories = Object.keys(sabioInfo.stats.categories || {}).length;
  // Get actual favorites count from localStorage
  const favorites = JSON.parse(localStorage.getItem('islamicFavorites') || '[]');
  const favoritesCount = favorites.length;
  
  return `
    <div class="hero islamic-pattern">
      <div class="container mx-auto px-4 text-center">
        ${sabioInfo.image ? `
          <div class="mb-6">
            <img src="${sabioInfo.image}" alt="${sabioInfo.name}" 
                 class="sabio-image w-32 h-32 md:w-48 md:h-48 rounded-full mx-auto border-4 border-white shadow-lg object-cover">
          </div>
        ` : ''}
        
        <h2 class="text-3xl md:text-4xl lg:text-6xl font-bold mb-6 calligraphy">
          ${sabioInfo.name}
        </h2>
        <p class="text-lg md:text-xl lg:text-2xl mb-8 opacity-90">ŸÖÿ≠ÿ™ŸàŸâ ÿ¥ÿßŸÖŸÑ ŸÖŸÜ ÿßŸÑÿπÿßŸÑŸÖ ŸàÿßŸÑÿØÿßÿπŸäÿ©</p>
        
        <!-- Stats container din√°mico seg√∫n categor√≠a -->
        <div class="stats-container">
          <div class="stats-card bg-white/10 backdrop-blur-sm border-white/20">
            <div class="stats-number text-white" id="sabio-stats-items">${totalFiles.toLocaleString('ar')}</div>
            <div class="stats-label text-white/80" id="sabio-stats-label">ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿßÿØ</div>
          </div>
          <div class="stats-card bg-white/10 backdrop-blur-sm border-white/20">
            <div class="stats-number text-white" id="sabio-stats-pages">${Math.ceil(totalFiles / SabioPagination.itemsPerPage).toLocaleString('ar')}</div>
            <div class="stats-label text-white/80">ÿµŸÅÿ≠ÿ©</div>
          </div>
          <div class="stats-card bg-white/10 backdrop-blur-sm border-white/20">
            <div class="stats-number text-white" id="sabio-stats-favorites">${favoritesCount.toLocaleString('ar')}</div>
            <div class="stats-label text-white/80">ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// Renderizar ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™
function renderCategoryButtons(sabioInfo) {
  if (!sabioInfo) return '';
  
  const totalFiles = sabioInfo.stats.total_audio + sabioInfo.stats.total_pdf;
  
  const categories = [
    { key: 'all', label: 'ÿßŸÑŸÉŸÑ', icon: '', count: totalFiles }, // Categor√≠a "Todo" por defecto
    { key: 'duruz', label: 'ÿØÿ±Ÿàÿ≥', icon: '' },
    { key: 'firak', label: 'ŸÅÿ±ŸÇ', icon: '' },
    { key: 'pdf', label: 'ŸÉÿ™ÿßÿ®', icon: '' }
  ];
  
  return categories.map(category => {
    // Para la categor√≠a "all", usar el conteo total; para otras, usar el conteo espec√≠fico
    const count = category.key === 'all' ? category.count : (sabioInfo.stats.categories[category.key] || 0);
    const isActive = SabioPageState.activeCategory === category.key;
    
    // Si el conteo es 0, ocultar completamente el bot√≥n
    if (count === 0) {
      return `
        <button 
          data-category="${category.key}"
          class="category-btn btn btn-outline text-lg px-6 py-3"
          style="display: none;"
          disabled
        >
          <span class="ml-2">${category.icon}</span>
          ${category.label}
        </button>
      `;
    }
    
    return `
      <button 
        data-category="${category.key}"
        class="category-btn btn ${isActive ? 'btn-primary' : 'btn-outline'} text-lg px-6 py-3"
      >
        <span class="ml-2">${category.icon}</span>
        ${category.label}
      </button>
    `;
  }).join('');
}

// SISTEMA DE PAGINACI√ìN PARA SABIO.JS
const SabioPagination = {
  itemsPerPage: 25,
  currentPage: 1,
  totalPages: 1,
  totalItems: 0
};

// Funci√≥n de paginaci√≥n (copiada de app.js)
function renderSabioPagination(currentPage, totalPages, totalItems, onPageClick) {
  if (totalPages <= 1) return '';
  
  let pagesHTML = '';
  const startPage = Math.max(1, currentPage - 2);
  const endPage = Math.min(totalPages, currentPage + 2);
  
  for (let i = startPage; i <= endPage; i++) {
    pagesHTML += `
      <button
        onclick="${onPageClick}(${i})"
        class="pagination-number ${currentPage === i ? 'active' : ''}"
      >
        ${i}
      </button>
    `;
  }
  
  return `
    <div class="pagination-container">
      <div class="pagination-info">
        <span>ÿµŸÅÿ≠ÿ© ${currentPage} ŸÖŸÜ ${totalPages} (${totalItems.toLocaleString('ar')} ÿπŸÜÿµÿ±)</span>
      </div>
      
      <div class="pagination-controls">
        <button 
          onclick="${onPageClick}(1)"
          ${currentPage === 1 ? 'disabled' : ''}
          class="pagination-btn"
        >
          ÿßŸÑÿ£ŸàŸÑŸâ
        </button>
        
        <button 
          onclick="${onPageClick}(${currentPage - 1})"
          ${currentPage === 1 ? 'disabled' : ''}
          class="pagination-btn"
        >
          ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
        </button>
        
        <div class="pagination-pages">
          ${pagesHTML}
        </div>

        <button 
          onclick="${onPageClick}(${currentPage + 1})"
          ${currentPage === totalPages ? 'disabled' : ''}
          class="pagination-btn"
        >
          ÿßŸÑÿ™ÿßŸÑŸäÿ©
        </button>
        
        <button 
          onclick="${onPageClick}(${totalPages})"
          ${currentPage === totalPages ? 'disabled' : ''}
          class="pagination-btn"
        >
          ÿßŸÑÿ£ÿÆŸäÿ±ÿ©
        </button>
      </div>
    </div>
  `;
}

// Funci√≥n para desplazarse al comienzo del contenido
function scrollToContentTop() {
  console.log('üìú Scrolling to content top');
  
  // Priorizar contentSection para posicionamiento perfecto
  const contentSection = document.getElementById('contentSection');
  const containerElement = document.querySelector('.container.mx-auto');
  const mainContent = document.getElementById('mainContent');
  
  if (contentSection) {
    // Posicionamiento perfecto en contentSection
    const rect = contentSection.getBoundingClientRect();
    const offsetTop = window.pageYOffset + rect.top - 20; // 20px de margen superior perfecto
    
    window.scrollTo({
      top: Math.max(0, offsetTop), // Asegurar que no sea negativo
      behavior: 'smooth'
    });
    console.log('‚úÖ Scrolled perfectly to contentSection');
  } else if (containerElement) {
    // Fallback: usar container con offset m√≠nimo
    const rect = containerElement.getBoundingClientRect();
    const offsetTop = window.pageYOffset + rect.top - 10;
    
    window.scrollTo({
      top: Math.max(0, offsetTop),
      behavior: 'smooth'
    });
    console.log('‚úÖ Scrolled to container position');
  } else {
    // Fallback final: scroll al top de la p√°gina
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
    console.log('‚ö†Ô∏è ContentSection not found, scrolled to page top');
  }
}

// Funci√≥n para navegar a p√°gina espec√≠fica
function loadSabioPage(pageNumber) {
  console.log(`loadSabioPage called with pageNumber: ${pageNumber}`);
  console.log(`Current pagination state:`, {
    currentPage: SabioPagination.currentPage,
    totalPages: SabioPagination.totalPages,
    totalItems: SabioPagination.totalItems
  });
  
  // Validar n√∫mero de p√°gina
  if (pageNumber < 1 || pageNumber > SabioPagination.totalPages) {
    console.warn(`‚ö†Ô∏è Invalid page number: ${pageNumber}. Valid range: 1-${SabioPagination.totalPages}`);
    return;
  }
  
  // Actualizar p√°gina actual ANTES de cargar contenido
  SabioPagination.currentPage = pageNumber;
  console.log(`‚úÖ Page set to: ${pageNumber}`);
  
  // Si ya tenemos el contenido cargado, solo re-renderizar con la nueva p√°gina
  if (SabioPageState.currentContent && SabioPageState.currentContent.files) {
    console.log(`üîÑ Re-rendering existing content for page ${pageNumber}`);
    renderSabioContent();
    // Desplazarse al comienzo de las cards despu√©s del re-renderizado
    scrollToContentTop();
  } else {
    console.log(`üì° Loading content for page ${pageNumber}`);
    // Recargar contenido con paginaci√≥n
    sabioLoadCategoryContent(SabioPageState.activeCategory);
    // El scroll se manejar√° despu√©s de que se complete la carga
  }
}

// Renderizar tarjetas de contenido con paginaci√≥n
function renderContentCards(contentData) {
  if (!contentData || !contentData.files || contentData.files.length === 0) {
    return `
      <div class="text-center py-8 text-gray-500">
        <div class="text-6xl mb-4">üìÇ</div>
        <h3 class="text-xl font-semibold mb-2">ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖÿ≠ÿ™ŸàŸâ ŸÖÿ™ÿßÿ≠</h3>
        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÑŸÅÿßÿ™ ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑÿ™ÿµŸÜŸäŸÅ</p>
      </div>
    `;
  }
  
  // Implementar paginaci√≥n
  const totalFiles = contentData.files.length;
  const totalPages = Math.ceil(totalFiles / SabioPagination.itemsPerPage);
  const startIndex = (SabioPagination.currentPage - 1) * SabioPagination.itemsPerPage;
  const endIndex = startIndex + SabioPagination.itemsPerPage;
  const paginatedFiles = contentData.files.slice(startIndex, endIndex);
  
  // Actualizar estado de paginaci√≥n
  SabioPagination.totalPages = totalPages;
  SabioPagination.totalItems = totalFiles;

  const cardsHTML = paginatedFiles.map(file => {
    const isAudio = file.type === 'audio';
    const isPdf = file.type === 'document';
    
    // Mostrar etiqueta de categor√≠a solo en vista "all"
    const categoryBadge = contentData.category === 'all' && file.categoryLabel ? 
      `<div class="mb-3">
         <p class="text-sm text-emerald-600 font-semibold">${file.categoryLabel}</p>
       </div>` : '';
    
    // Usar la misma estructura que app.js
    const mediaHTML = `
      <div class="attachments-grid mb-4">
        <button
          onclick="handleFileClick('${file.path}', '${file.name}', '${file.extension}', '${file.type}')"
          class="attachment-link ${isAudio ? 'audio-link' : ''}"
        >
          <span>${isAudio ? 'ÿµŸàÿ™Ÿä' : 'ŸÖŸÑŸÅ'}</span>
          <span>${file.extension.toUpperCase()}</span>
          <span class="text-xs opacity-75">(${isAudio ? 'ÿßÿ≥ÿ™ŸÖÿßÿπ' : 'ÿ™ÿ≠ŸÖŸäŸÑ'})</span>
        </button>
      </div>
    `;
    
    const contentHTML = `
      <p class="text-gray-600 mb-4 arabic-text leading-relaxed line-clamp-3 text-sm lg:text-base">
        ${file.name}
      </p>
    `;
    
    return `
      <div class="card fade-in">
        <div class="flex justify-between items-start mb-3">
          <span class="content-type-badge ${isAudio ? 'type-audios' : 'type-books'}">
            ${isAudio ? 'ÿµŸàÿ™Ÿä' : 'ŸÉÿ™ÿßÿ®'}
          </span>
          <button onclick="toggleSabioFavorite('${file.path}', '${file.name}')" class="btn-icon favorite-btn ${isSabioItemFavorited(file.path) ? 'favorited' : ''}" title="${isSabioItemFavorited(file.path) ? 'ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©' : 'ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑŸÖŸÅÿ∂ŸÑÿ©'}" style="${isSabioItemFavorited(file.path) ? 'color: #ef4444;' : ''}">
            <svg class="w-5 h-5" fill="${isSabioItemFavorited(file.path) ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
            </svg>
          </button>
        </div>

        <h4 class="text-lg font-bold text-gray-900 mb-2 arabic-text leading-relaxed">
          ${file.name}
        </h4>

        ${contentHTML}
        ${categoryBadge}
        ${mediaHTML}

        <div class="flex justify-between items-center text-xs lg:text-sm text-gray-500 mt-3">
          <span class="inline-flex items-center gap-1">
            <svg class="w-3 h-3 lg:w-4 lg:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
            </svg>
            ${formatFileSize(file.size)}
          </span>
          <span>${file.categoryLabel || ''}</span>
        </div>
      </div>
    `;
  }).join('');
  
  // Renderizar paginaci√≥n si hay m√°s de una p√°gina
  const paginationHTML = totalPages > 1 ? renderSabioPagination(SabioPagination.currentPage, totalPages, totalFiles, 'loadSabioPage') : '';
  
  // Grid responsive: 2 en m√≥vil, 3 en tablet y desktop
  return `
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-3 gap-4 lg:gap-6 mt-6" style="margin-top:25px">
      ${cardsHTML}
    </div>
    ${paginationHTML}
  `;
}

// Sistema de favoritos para sabio.html (id√©ntico a index.html)
function toggleSabioFavorite(filePath, fileName) {
  console.log('üî• SABIO.JS: toggleSabioFavorite called for:', fileName);
  
  // Determinar tipo de archivo
  const isAudio = filePath.includes('.mp3') || filePath.includes('.wav') || filePath.includes('.m4a');
  const isPdf = filePath.includes('.pdf');
  
  // Crear objeto item completo similar al de index.html
  const item = {
    id: filePath, // Usar filePath como ID √∫nico
    title: fileName,
    url: filePath,
    download_link: filePath,
    type: isAudio ? 'audios' : (isPdf ? 'books' : 'document'),
    category: isAudio ? 'audios' : 'books',
    author: SabioPageState.selectedSabio || 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
    description: `ŸÖÿ≠ÿ™ŸàŸâ ŸÖŸÜ ${SabioPageState.selectedSabio || 'ÿßŸÑÿ¥ŸäÿÆ'} - ${fileName}`,
    date: new Date().toISOString().split('T')[0], // ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸäŸàŸÖ
    views: 0,
    favorites: 0,
    // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑÿµŸàÿ™Ÿäÿßÿ™
    ...(isAudio && {
      audio: filePath,
      duration: 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'
    }),
    // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ•ÿ∂ÿßŸÅŸäÿ© ŸÑŸÑŸÉÿ™ÿ®
    ...(isPdf && {
      pages: 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ',
      format: 'PDF',
      publisher: 'ÿ®Ÿäÿ™ ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖ'
    }),
    // ÿ•ÿ∂ÿßŸÅÿ© attachments ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ/ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ
    attachments: [{
      url: filePath,
      extension_type: isAudio ? 'MP3' : (isPdf ? 'PDF' : 'FILE'),
      size: 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ'
    }],
    // ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ŸäÿÆ
    sabio_name: SabioPageState.selectedSabio,
    sabio_category: SabioPageState.activeCategory,
    source: 'sabio_page' // ŸÑŸÑÿ™ŸÖŸäŸäÿ≤ ÿ£ŸÜ Ÿáÿ∞ÿß ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ¥ŸäÿÆ
  };
  
  // Usar el sistema de localStorage id√©ntico a index.html
  const favorites = JSON.parse(localStorage.getItem('islamicFavorites') || '[]');
  const favoritesData = JSON.parse(localStorage.getItem('islamicFavoritesData') || '{}');
  
  const idStr = filePath.toString();
  const index = favorites.indexOf(idStr);
  
  let newFavorites, newFavoritesData;
  let isFavorited;
  
  if (index === -1) {
    // Agregar a favoritos
    newFavorites = [...favorites, idStr];
    newFavoritesData = { ...favoritesData, [idStr]: item };
    isFavorited = true;
    console.log(`Added "${fileName}" to favorites`);
  } else {
    // Quitar de favoritos
    newFavorites = favorites.filter((_, i) => i !== index);
    const { [idStr]: removed, ...rest } = favoritesData;
    newFavoritesData = rest;
    isFavorited = false;
    console.log(`üíî Removed "${fileName}" from favorites`);
  }
  
  // Guardar en localStorage (id√©ntico a index.html)
  localStorage.setItem('islamicFavorites', JSON.stringify(newFavorites));
  localStorage.setItem('islamicFavoritesData', JSON.stringify(newFavoritesData));
  
  // Actualizar visualmente el bot√≥n que se acaba de hacer clic
  const button = event.target.closest('.favorite-btn');
  if (button) {
    const svg = button.querySelector('svg');
    
    if (isFavorited) {
      button.classList.add('favorited');
      button.style.color = '#ef4444'; // Color rojo para favorito
      if (svg) {
        svg.setAttribute('fill', 'currentColor');
      }
      button.title = 'ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©';
    } else {
      button.classList.remove('favorited');
      button.style.color = ''; // Restaurar color original
      if (svg) {
        svg.setAttribute('fill', 'none');
      }
      button.title = 'ÿ•ÿ∂ÿßŸÅÿ© ŸÑŸÑŸÖŸÅÿ∂ŸÑÿ©';
    }
  }
  
  // Actualizar contador de favoritos globalmente
  updateGlobalFavoritesCount();
  
  // Mostrar mensaje de confirmaci√≥n
  const message = isFavorited ? `ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© "${fileName}" ŸÑŸÑŸÖŸÅÿ∂ŸÑÿ©` : `ÿ™ŸÖ ÿ≠ÿ∞ŸÅ "${fileName}" ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©`;
  
  // Use global notification system if available, otherwise fallback to sabio-specific
  if (typeof window.showNotification === 'function') {
    window.showNotification(message, isFavorited ? 'success' : 'info');
  } else {
    showSabioNotification(message, isFavorited ? 'success' : 'info');
  }
  
  // Sync favorites counter globally
  if (typeof window.syncFavoritesCounter === 'function') {
    window.syncFavoritesCounter();
  }
}

// Manejar click en archivos
function handleFileClick(filePath, fileName, extension, fileType) {
  if (fileType === 'audio') {
    // Usar el sistema de audio player existente
    if (window.handleMediaClick) {
      window.handleMediaClick(filePath, fileName, extension);
    } else {
      // Fallback: reproducir directamente
      const audio = new Audio(filePath);
      audio.play().catch(e => console.error('Error playing audio:', e));
    }
  } else {
    // Para PDFs, abrir en nueva ventana
    window.open(filePath, '_blank');
  }
}

// Formatear tama√±o de archivo
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Sincronizar AppState con datos de sabio para evitar conflictos
function syncAppStateWithSabio() {
  if (window.AppState && SabioPageState.sabioInfo) {
    const totalFiles = SabioPageState.sabioInfo.stats.total_audio + SabioPageState.sabioInfo.stats.total_pdf;
    const totalPages = Math.ceil(totalFiles / SabioPagination.itemsPerPage);
    const favorites = JSON.parse(localStorage.getItem('islamicFavorites') || '[]');
    
    // Sincronizar AppState con datos correctos de sabio
    window.AppState.totalItems = totalFiles;
    window.AppState.totalPages = totalPages;
    window.AppState.favorites = favorites;
    
    console.log(`üîÑ Synced AppState with sabio data: ${totalFiles} items, ${totalPages} pages, ${favorites.length} favorites`);
  }
}

// Actualizar estad√≠sticas din√°micamente seg√∫n categor√≠a activa y contenido real
function updateSabioStatsDisplay() {
  const activeCategory = SabioPageState.activeCategory;
  const favoritesCount = window.AppState ? window.AppState.favorites.length : 0;
  
  console.log(`üîç DEBUG updateSabioStatsDisplay: activeCategory="${activeCategory}"`);
  console.log(`üîç DEBUG currentContent:`, SabioPageState.currentContent);
  
  // Calcular conteos seg√∫n el contenido real cargado
  let itemCount = 0, label;
  
  if (SabioPageState.currentContent && SabioPageState.currentContent.files) {
    itemCount = SabioPageState.currentContent.files.length;
    console.log(`üîç DEBUG: Found ${itemCount} files in currentContent`);
  } else {
    console.log(`üîç DEBUG: No currentContent or files found`);
  }
  
  // Establecer etiqueta seg√∫n la categor√≠a
  switch (activeCategory) {
    case 'all':
      label = 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸàÿßÿØ';
      break;
    case 'duruz':
      label = 'ÿØÿ±Ÿàÿ≥';
      break;
    case 'firak':
      label = 'ŸÅÿ±ŸÇ';
      break;
    case 'pdf':
      label = 'ŸÉÿ™ÿ®';
      break;
    default:
      label = 'ŸÖŸàÿßÿØ';
  }
  
  const totalPages = Math.ceil(itemCount / SabioPagination.itemsPerPage);
  
  console.log(`üîç DEBUG: itemCount=${itemCount}, totalPages=${totalPages}, label="${label}"`);
  
  // Actualizar elementos espec√≠ficos por ID
  const itemsElement = document.getElementById('sabio-stats-items');
  const pagesElement = document.getElementById('sabio-stats-pages');
  const favoritesElement = document.getElementById('sabio-stats-favorites');
  const labelElement = document.getElementById('sabio-stats-label');
  
  if (itemsElement) {
    itemsElement.textContent = itemCount.toLocaleString('ar');
    console.log(`‚úÖ Updated items: ${itemCount}`);
  }
  if (pagesElement) {
    pagesElement.textContent = totalPages.toLocaleString('ar');
    console.log(`‚úÖ Updated pages: ${totalPages}`);
  }
  if (favoritesElement) {
    favoritesElement.textContent = favoritesCount.toLocaleString('ar');
    console.log(`‚úÖ Updated favorites: ${favoritesCount}`);
  }
  if (labelElement) {
    labelElement.textContent = label;
    console.log(`‚úÖ Updated label: ${label}`);
  }
  
  console.log(`üìä Stats updated for category "${activeCategory}": ${itemCount} items, ${totalPages} pages, ${favoritesCount} favorites`);
}

// Funci√≥n global para actualizar contadores de favoritos en todas las p√°ginas
function updateGlobalFavoritesCount() {
  const favorites = JSON.parse(localStorage.getItem('islamicFavorites') || '[]');
  const favoritesCount = favorites.length;
  
  // Actualizar contadores en sabio.html
  updateSabioStatsDisplay();
  
  // IMPORTANTE: Solo actualizar contadores de app.js si NO estamos en sabio.html
  // Esto evita que app.js sobrescriba los contadores correctos de sabio con valores 0
  if (window.updateStatsDisplay && !window.location.pathname.includes('sabio.html')) {
    window.updateStatsDisplay();
  } else if (window.location.pathname.includes('sabio.html')) {
    console.log('üö´ Skipping app.js updateStatsDisplay in sabio.html to prevent counter reset');
  }
  
  console.log(`üåç Global favorites count updated: ${favoritesCount}`);
}

// Funci√≥n para mostrar notificaciones (similar a index.html)
function showSabioNotification(message, type = 'info') {
  // Crear elemento de notificaci√≥n
  const notification = document.createElement('div');
  notification.className = `sabio-notification ${type}`;
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${type === 'success' ? '#10b981' : '#3b82f6'};
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    font-size: 14px;
    max-width: 300px;
    transform: translateX(100%);
    transition: transform 0.3s ease;
  `;
  notification.textContent = message;
  
  document.body.appendChild(notification);
  
  // Animar entrada
  setTimeout(() => {
    notification.style.transform = 'translateX(0)';
  }, 10);
  
  // Remover despu√©s de 3 segundos
  setTimeout(() => {
    notification.style.transform = 'translateX(100%)';
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 300);
  }, 3000);
}

// Funci√≥n para verificar si un item est√° en favoritos
function isSabioItemFavorited(filePath) {
  const favorites = JSON.parse(localStorage.getItem('islamicFavorites') || '[]');
  return favorites.includes(filePath.toString());
}

// Cargar contenido de una categor√≠a espec√≠fica - FUNCI√ìN ESPEC√çFICA DE SABIO.JS
async function sabioLoadCategoryContent(category) {
  console.log('üî• SABIO.JS FUNCTION: sabioLoadCategoryContent called');
  return await loadCategoryContentInternal(category);
}

// Funci√≥n interna para cargar contenido (renombrada para evitar conflictos)
async function loadCategoryContentInternal(category) {
  console.log('üö® FUNCTION START: loadCategoryContent called with category:', category);
  console.log('üö® FUNCTION START: typeof category:', typeof category);
  console.log('üö® FUNCTION START: SabioPageState exists:', !!SabioPageState);
  
  console.log(`Loading category content: "${category}"`);
  console.log('SabioPageState debug:');
  console.log('  - selectedSabio:', SabioPageState.selectedSabio);
  console.log('  - sabioInfo:', SabioPageState.sabioInfo ? 'exists' : 'null');
  console.log('  - activeCategory:', SabioPageState.activeCategory);
  console.log('  - localStorage sabio:', localStorage.getItem('selectedSabio'));
  
  // Reset pagination SOLO cuando cambia la categor√≠a (no en navegaci√≥n de p√°ginas)
  if (SabioPageState.activeCategory !== category) {
    console.log(`üîÑ Category changed from "${SabioPageState.activeCategory}" to "${category}" - resetting pagination`);
    SabioPagination.currentPage = 1;
  } else {
    console.log(`Same category "${category}" - keeping current page: ${SabioPagination.currentPage}`);
  }
  
  if (!SabioPageState.selectedSabio) {
    console.error('‚ùå No sabio selected in SabioPageState');
    console.log('üîß Attempting to recover from localStorage...');
    const sabioFromStorage = localStorage.getItem('selectedSabio');
    if (sabioFromStorage) {
      console.log(`üîÑ Recovering sabio from localStorage: "${sabioFromStorage}"`);
      SabioPageState.selectedSabio = sabioFromStorage;
    } else {
      console.error('‚ùå No sabio found in localStorage either!');
      return;
    }
  }
  
  console.log(`Using sabio: "${SabioPageState.selectedSabio}"`);
  console.log(`Proceeding with category: "${category}"`);
  
  // Verificar que tenemos la informaci√≥n del sabio
  if (!SabioPageState.sabioInfo) {
    console.warn('‚ö†Ô∏è sabioInfo is missing, this might cause issues');
  }
  
  SabioPageState.activeCategory = category;
  console.log(`üè∑Ô∏è Active category set to: "${category}"`);
  
  // Actualizar estad√≠sticas seg√∫n la nueva categor√≠a
  updateSabioStatsDisplay();
  
  // Actualizar botones de categor√≠a visualmente
  const categoryButtons = document.querySelectorAll('.category-btn');
  categoryButtons.forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.category === category) {
      btn.classList.add('active');
    }
  });
  
  const contentSection = document.getElementById('contentSection');
  if (contentSection) {
    contentSection.innerHTML = `
      <div class="loading-spinner text-center py-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto"></div>
        <p class="mt-4 text-emerald-700">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</p>
      </div>
    `;
  }
  
  try {
    let contentData;
    
    if (category === 'all') {
      console.log('üìÇ Loading ALL categories content');
      // Para "all", cargar contenido de todas las categor√≠as
      const categories = ['duruz', 'firak', 'pdf'];
      const allFiles = [];
      
      for (const cat of categories) {
        try {
          const catData = await loadSabioContent(SabioPageState.selectedSabio, cat);
          if (catData && catData.files && catData.files.length > 0) {
            // Agregar categor√≠a a cada archivo para identificaci√≥n
            catData.files.forEach(file => {
              file.category = cat;
              file.categoryLabel = cat === 'duruz' ? 'ÿØÿ±Ÿàÿ≥' : cat === 'firak' ? 'ŸÅÿ±ŸÇ' : 'ŸÉÿ™ÿßÿ®';
            });
            allFiles.push(...catData.files);
          }
        } catch (error) {
          console.warn(`Warning: Could not load category "${cat}":`, error);
        }
      }
      
      contentData = {
        sabio: SabioPageState.selectedSabio,
        category: 'all',
        files: allFiles,
        total: allFiles.length
      };
      
      console.log(`‚úÖ Loaded ${allFiles.length} total files from all categories`);
    } else {
      console.log(`Loading specific category: "${category}"`);
      contentData = await loadSabioContent(SabioPageState.selectedSabio, category);
    }
    
    SabioPageState.currentContent = contentData;
    
    // Actualizar estad√≠sticas con el contenido real cargado
    updateSabioStatsDisplay();
    
    // Renderizar contenido
    renderSabioContent();
  } catch (error) {
    console.error('Error loading category content:', error);
    if (contentSection) {
      contentSection.innerHTML = `
        <div class="text-center py-8 text-red-500">
          ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ
        </div>
      `;
    }
  }
}

// Inicializar la p√°gina del sabio
async function initializeSabioPage() {
  console.log('üöÄ Initializing Sabio Page...');
  
  // Obtener el sabio seleccionado de localStorage
  const selectedSabio = localStorage.getItem('selectedSabio');
  console.log('Selected sabio from localStorage:', selectedSabio);
  
  if (!selectedSabio) {
    console.error('‚ùå No sabio selected in localStorage, redirecting to index.html');
    // Para debugging, vamos a establecer un sabio por defecto en lugar de redirigir
    const defaultSabio = 'sheik ibn baz';
    console.log(`üîß Setting default sabio: "${defaultSabio}" for testing`);
    localStorage.setItem('selectedSabio', defaultSabio);
    // window.location.href = 'index.html';
    // return;
  }
  
  SabioPageState.selectedSabio = selectedSabio;
  
  // Cargar informaci√≥n del sabio
  const sabioInfo = await loadSabioInfo(selectedSabio);
  
  if (!sabioInfo) {
    // Mostrar error si no se puede cargar la informaci√≥n
    const mainContent = document.getElementById('mainContent');
    if (mainContent) {
      mainContent.innerHTML = `
        <div class="container mx-auto px-4 py-12 text-center">
          <h2 class="text-2xl font-bold text-red-600 mb-4">ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ</h2>
          <p class="text-gray-600 mb-8">ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπŸÑŸàŸÖÿßÿ™ "${selectedSabio}"</p>
          <button onclick="window.location.href='index.html'" class="btn btn-primary">
            ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
          </button>
        </div>
      `;
    }
    return;
  }
  
  SabioPageState.sabioInfo = sabioInfo;
  
  // Renderizar ÿßŸÑÿµŸÅÿ≠ÿ©
  renderSabioContent();
  
  // Actualizar t√≠tulo de la p√°gina
  document.title = `${selectedSabio} - ÿ®Ÿäÿ™ ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖ`;
  
  // Configurar protecci√≥n del DOM
  setupDOMProtection();
  
  // Cargar autom√°ticamente la categor√≠a "all" por defecto
  console.log('üöÄ Auto-loading default category: "all"');
  sabioLoadCategoryContent('all');
}

function renderSabioContent() {
  const mainContent = document.getElementById('mainContent');
  if (!mainContent) {
    console.error('Main content container not found');
    return;
  }

  // FORZAR limpieza del contenido previo de app.js
  mainContent.innerHTML = '';
  
  // Asegurar que el estado de sabio tenga prioridad
  window.SABIO_PAGE_ACTIVE = true;

  if (!SabioPageState.sabioInfo) {
    mainContent.innerHTML = `
      <div class="error-container">
        <div class="error-message">
          <h2>ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h2>
          <p>ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ¥ŸäÿÆ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®</p>
          <button onclick="window.location.reload()" class="retry-btn">ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©</button>
        </div>
      </div>
    `;
    return;
  }

  const heroSection = renderSabioHero(SabioPageState.sabioInfo);
  const categoryButtons = renderCategoryButtons(SabioPageState.sabioInfo);
  
  // Mejorar la l√≥gica de renderizado de contenido
  let contentCards;
  if (SabioPageState.currentContent && SabioPageState.currentContent.files && SabioPageState.currentContent.files.length > 0) {
    contentCards = renderContentCards(SabioPageState.currentContent);
  } else {
    // Mostrar mensaje de carga mientras se obtiene el contenido
    contentCards = `
      <div class="loading-container text-center py-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto"></div>
        <p class="mt-4 text-emerald-700">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ...</p>
      </div>
    `;
  }

  // RENDERIZADO FORZADO - sobrescribir cualquier contenido previo
  mainContent.innerHTML = `
    ${heroSection}
    <div class="container mx-auto px-4 py-8">
      ${categoryButtons}
      <div id="contentSection" class="mt-8">
        ${contentCards}
      </div>
    </div>
  `;

  // Actualizar navegaci√≥n activa
  if (SabioPageState.activeCategory) {
    const activeBtn = document.querySelector(`[data-category="${SabioPageState.activeCategory}"]`);
    if (activeBtn) {
      activeBtn.classList.add('active');
      activeBtn.classList.remove('btn-outline');
    }
  }
  
  console.log('‚úÖ Sabio content rendered successfully');
  
  // Actualizar estad√≠sticas despu√©s del renderizado
  setTimeout(() => {
    updateSabioStatsDisplay();
  }, 50);
  
  // IMPORTANTE: Configurar event listeners DESPU√âS de renderizar
  setTimeout(() => {
    setupCategoryEventListeners();
  }, 100); // Breve delay para asegurar que el DOM se haya actualizado
  
  // Si estamos en una p√°gina diferente a la 1, hacer scroll al contenido
  // (esto maneja el caso cuando se carga contenido nuevo via paginaci√≥n)
  if (SabioPagination.currentPage > 1) {
    setTimeout(() => {
      scrollToContentTop();
    }, 200); // Delay adicional para asegurar que el renderizado est√© completo
  }
}

// ...

// Listen for favorites updates from other pages
window.addEventListener('favoritesUpdated', function(event) {
  const { count, favorites } = event.detail;
  
  // Update favorites count in stats display
  const statsElements = document.querySelectorAll('.stats-number');
  if (statsElements.length >= 3) {
    statsElements[2].textContent = count.toLocaleString('ar');
  }
});

// Event listeners - PRIORIDAD ABSOLUTA (solo en sabio.html)
document.addEventListener('DOMContentLoaded', function() {
  // Solo ejecutar la l√≥gica completa de sabio.js en sabio.html
  if (!window.SABIO_PAGE_ACTIVE) {
    console.log('üöÄ Sabio.js loaded in index.html - providing categories functionality only');
    return; // Exit early, don't run sabio-specific initialization
  }
  
  console.log('üöÄ Sabio.js DOMContentLoaded - PRIORITY CONTROL');
  
  // Configurar protecci√≥n del DOM
  setupDOMProtection();
  
  // Prevenir interferencia de app.js
  preventAppJsInterference();
  
  // Check for saved navigation state and restore it (same behavior as index.html)
  const savedNavState = localStorage.getItem('sabioNavState');
  console.log('üîç DEBUGGING: Checking for sabio navigation state...');
  console.log('üîç savedNavState:', savedNavState);
  
  // Clear old complex navigation state to prevent conflicts
  localStorage.removeItem('currentNavigationState');
  
  if (savedNavState) {
    try {
      const navState = JSON.parse(savedNavState);
      const timeDiff = Date.now() - navState.timestamp;
      
      console.log('üîç DEBUGGING: Found saved navigation state:', navState);
      console.log('üîç Time difference (minutes):', timeDiff / 60000);
      
      // Only restore if less than 1 hour old and matches current page type
      if (timeDiff < 3600000 && navState.pageType === 'sabio') {
        console.log(`üîÑ ‚úÖ RESTORING sabio navigation state: ${navState.page}`);
        
        // Update navigation UI
        document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
          link.classList.remove('active');
          if (link.dataset.page === navState.page) {
            link.classList.add('active');
          }
        });
        
        // Handle different navigation states
        if (navState.page === 'favorites') {
          // Load sabio info first, then show favorites
          initializeSabioPageNormally(() => {
            setTimeout(() => {
              renderFavoritesPage();
            }, 500);
          });
        } else if (navState.page === 'categories') {
          // Load sabio info first, then show categories
          initializeSabioPageNormally(() => {
            setTimeout(() => {
              renderCategoriesPage();
            }, 500);
          });
        } else {
          // For home or other states, initialize sabio page normally
          initializeSabioPageNormally();
        }
        
        // Clear the saved state since we've used it
        localStorage.removeItem('sabioNavState');
        
        return; // Exit early, don't run normal initialization
      } else {
        // Clear old state
        localStorage.removeItem('sabioNavState');
      }
    } catch (e) {
      console.error('Error parsing saved navigation state:', e);
      localStorage.removeItem('sabioNavState');
    }
  }
  
  // Normal initialization if no valid saved state
  initializeSabioPageNormally();
  
  console.log('‚úÖ Sabio.js initialization complete');
});

// Function to handle normal sabio page initialization
function initializeSabioPageNormally(callback) {
  // Obtener el nombre del sabio de la URL
  const urlParams = new URLSearchParams(window.location.search);
  let sabioName = urlParams.get('sabio');
  
  // Si no est√° en la URL, intentar obtenerlo de localStorage (respaldo)
  if (!sabioName) {
    sabioName = localStorage.getItem('selectedSabio');
    console.log(`üîÑ No sabio in URL, trying localStorage: ${sabioName}`);
    
    // Si encontramos el sabio en localStorage, actualizar la URL
    if (sabioName) {
      const newUrl = `${window.location.pathname}?sabio=${encodeURIComponent(sabioName)}`;
      window.history.replaceState({}, '', newUrl);
      console.log(`üîÑ Updated URL with sabio parameter: ${newUrl}`);
    }
  }
  
  if (sabioName) {
    console.log(`üìñ Loading sabio: "${sabioName}"`);
    
    SabioPageState.selectedSabio = sabioName;
    
    // Cargar informaci√≥n y contenido del sabio
    loadSabioInfo(sabioName).then(sabioInfo => {
      if (sabioInfo) {
        SabioPageState.sabioInfo = sabioInfo;
        console.log('‚úÖ Sabio info saved to SabioPageState:', SabioPageState.sabioInfo);
        
        // Ejecutar callback si se proporciona
        if (callback) {
          callback();
          return;
        }
        
        // Cargar contenido inicial (categor√≠a "Todo") despu√©s de cargar la info
        renderSabioContent();
        setTimeout(() => {
          loadCategoryContentInternal('all');
        }, 200);
      } else {
        console.error('‚ùå Failed to load sabio info');
      }
    }).catch(error => {
      console.error('‚ùå Error loading sabio info:', error);
    });
  } else {
    console.error('‚ùå No sabio name found in URL or localStorage');
    // Redirigir a la p√°gina principal si no hay sabio especificado
    window.location.href = 'index.html';
  }
  
  // Inicializar caracter√≠sticas compatibles de app.js
  setTimeout(() => {
    initializeCompatibleAppJsFeatures();
  }, 100);
  
  // Configurar event listeners despu√©s del renderizado inicial
  setTimeout(() => {
    setupCategoryEventListeners();
  }, 500);
  
  // Limpiar cualquier interferencia adicional de app.js
  setTimeout(() => {
    cleanupAppJsInterference();
  }, 1000);
}

// Funci√≥n para inicializar SOLO las caracter√≠sticas compatibles de app.js
// PERMITIDO: search, audio manager, y navegaci√≥n esencial
function initializeCompatibleAppJsFeatures() {
  console.log('Initializing allowed app.js features: search + audio manager + navigation');
  
  // PERMITIR: Funcionalidades del reproductor de audio
  if (window.AppState && window.AppState.audioQueue !== undefined) {
    console.log('‚úÖ ALLOWED: Audio player functionality from app.js');
    
    // Asegurar que las funciones de audio est√©n disponibles
    if (window.handleMediaClick) {
      console.log('  - handleMediaClick available');
    }
    if (window.togglePlayPause) {
      console.log('  - togglePlayPause available');
    }
    if (window.playNext) {
      console.log('  - playNext available');
    }
    if (window.playPrevious) {
      console.log('  - playPrevious available');
    }
    if (window.toggleQueue) {
      console.log('  - toggleQueue available');
    }
    if (window.clearQueue) {
      console.log('  - clearQueue available');
    }
  }
  
  // IMPLEMENTAR: Sistema de b√∫squeda dedicado para sabio.html
  initializeSabioSearch();
  console.log('‚úÖ IMPLEMENTED: Dedicated search system for sabio.html');
  
  // PERMITIR: Funcionalidades de navegaci√≥n esenciales
  if (window.toggleMobileMenu) {
    console.log('‚úÖ ALLOWED: Mobile menu functionality from app.js');
  }
  if (window.closeMobileMenu) {
    console.log('‚úÖ ALLOWED: Close mobile menu functionality from app.js');
  }
  
  // PERMITIR: Funcionalidades del mega men√∫ de sabios
  if (window.toggleMegaMenu) {
    console.log('‚úÖ ALLOWED: Sabios mega menu functionality from app.js');
  }
  if (window.closeMegaMenu) {
    console.log('‚úÖ ALLOWED: Close sabios mega menu functionality from app.js');
  }
  if (window.navigateToSabio) {
    console.log('‚úÖ ALLOWED: Navigate to sabio functionality from app.js');
  }
  
  // PERMITIR: Funcionalidades de favoritos (para compatibilidad)
  if (window.toggleFavorite) {
    console.log('‚úÖ ALLOWED: Favorites functionality from app.js');
  }
  
  // PERMITIR: Funcionalidades de video
  if (window.showVideoPlayer) {
    console.log('‚úÖ ALLOWED: Video player functionality from app.js');
  }
  if (window.closeVideoPlayer) {
    console.log('‚úÖ ALLOWED: Close video player functionality from app.js');
  }
  
  console.log('‚ùå BLOCKED: Only content rendering and category filtering functions');
}

// Funci√≥n navigateToPage espec√≠fica para sabio.html - override app.js version
function navigateToPage(page) {
  console.log(`üß≠ Sabio.js navigateToPage called with: "${page}"`);
  
  // Cerrar men√∫ m√≥vil si est√° abierto
  if (window.closeMobileMenu) {
    window.closeMobileMenu();
  }
  
  // IMPORTANTE: Guardar estado de navegaci√≥n para todas las p√°ginas (igual que index.html)
  const simpleState = {
    page: page,
    timestamp: Date.now(),
    pageType: 'sabio'
  };
  
  localStorage.setItem('sabioNavState', JSON.stringify(simpleState));
  console.log(`üîÑ Sabio navigation state saved: ${page}`);
  
  // Actualizar estados de navegaci√≥n activa
  document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
    link.classList.remove('active');
    if (link.dataset.page === page) {
      link.classList.add('active');
    }
  });
  
  // Manejar diferentes p√°ginas
  switch (page) {
    case 'categories':
      console.log('üè∑Ô∏è Showing categories page in sabio.html');
      SabioPageState.activeNav = 'categories';
      renderCategoriesPage();
      break;
    case 'favorites':
      console.log('üî• Showing favorites page in sabio.html');
      SabioPageState.activeNav = 'favorites';
      renderFavoritesPage();
      break;
    case 'home':
    default:
      console.log('Returning to sabio main content');
      SabioPageState.activeNav = 'home';
      // Limpiar estado de navegaci√≥n al volver a home
      localStorage.removeItem('sabioNavState');
      localStorage.removeItem('currentNavigationState');
      console.log('üóëÔ∏è Navigation states cleared - returning to sabio main content');
      
      // Asegurar que tenemos la informaci√≥n del sabio antes de renderizar
      if (!SabioPageState.sabioInfo && SabioPageState.selectedSabio) {
        console.log('üîÑ Reloading sabio info before rendering content...');
        loadSabioInfo(SabioPageState.selectedSabio).then(sabioInfo => {
          if (sabioInfo) {
            SabioPageState.sabioInfo = sabioInfo;
            renderSabioContent();
            // Cargar contenido por defecto
            setTimeout(() => {
              loadCategoryContentInternal('all');
            }, 100);
          }
        });
      } else {
        renderSabioContent();
        // Asegurar que se carga el contenido
        setTimeout(() => {
          if (!SabioPageState.currentContent || !SabioPageState.currentContent.files) {
            console.log('üîÑ No content found, loading default category...');
            loadCategoryContentInternal('all');
          }
        }, 100);
      }
      break;
  }
}

// Renderizar p√°gina de categor√≠as similar a index.html
function renderCategoriesPage() {
  const mainContent = document.getElementById('mainContent');
  if (!mainContent) return;
  
  // Limpiar contenido previo
  mainContent.innerHTML = '';
  
  // Definir categor√≠as disponibles (similar a app.js)
  const categories = [
    {
      key: 'books',
      name: 'ÿßŸÑŸÉÿ™ÿ®',
      icon: '',
      color: 'from-blue-500 to-blue-600',
      description: 'ŸÖÿ¨ŸÖŸàÿπÿ© ÿ¥ÿßŸÖŸÑÿ© ŸÖŸÜ ÿßŸÑŸÉÿ™ÿ® ÿßŸÑÿ•ÿ≥ŸÑÿßŸÖŸäÿ©'
    },
    {
      key: 'articles', 
      name: 'ÿßŸÑŸÖŸÇÿßŸÑÿßÿ™',
      icon: '',
      color: 'from-green-500 to-green-600',
      description: 'ŸÖŸÇÿßŸÑÿßÿ™ ŸàÿØÿ±ÿßÿ≥ÿßÿ™ ÿ•ÿ≥ŸÑÿßŸÖŸäÿ© ŸÖÿ™ŸÜŸàÿπÿ©'
    },
    {
      key: 'fatwa',
      name: 'ÿßŸÑŸÅÿ™ÿßŸàŸâ',
      icon: '‚öñÔ∏è',
      color: 'from-purple-500 to-purple-600', 
      description: 'ŸÅÿ™ÿßŸàŸâ ÿ¥ÿ±ÿπŸäÿ© ŸÖŸÜ ÿπŸÑŸÖÿßÿ° ŸÖÿπÿ™ÿ®ÿ±ŸäŸÜ'
    },
    {
      key: 'audios',
      name: 'ÿßŸÑÿµŸàÿ™Ÿäÿßÿ™',
      icon: '',
      color: 'from-red-500 to-red-600',
      description: 'ŸÖÿ≠ÿßÿ∂ÿ±ÿßÿ™ ŸàÿØÿ±Ÿàÿ≥ ÿµŸàÿ™Ÿäÿ©'
    },
    {
      key: 'videos',
      name: 'ÿßŸÑŸÖÿ±ÿ¶Ÿäÿßÿ™', 
      icon: '',
      color: 'from-yellow-500 to-yellow-600',
      description: 'ŸÖÿ≠ÿßÿ∂ÿ±ÿßÿ™ ŸàÿØÿ±Ÿàÿ≥ ŸÖÿ±ÿ¶Ÿäÿ©'
    },
    {
      key: 'videos_ulamah',
      name: 'ŸÅŸäÿØŸäŸàŸáÿßÿ™ ÿØÿπŸàŸäŸá', 
      icon: '',
      color: 'from-purple-500 to-purple-600',
      description: 'ŸÅŸäÿØŸäŸàŸáÿßÿ™ ŸàŸÖÿ≠ÿßÿ∂ÿ±ÿßÿ™ ÿßŸÑÿπŸÑŸÖÿßÿ°'
    }
  ];
  
  const categoriesHTML = categories.map(category => `
    <div 
      class="category-card bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 cursor-pointer transform hover:-translate-y-1 p-6 text-center"
      onclick="filterByTypeAndNavigate('${category.key}')"
    >
      <div class="category-icon bg-gradient-to-br ${category.color} text-white mx-auto mb-4 w-12 h-12 lg:w-16 lg:h-16 rounded-full flex items-center justify-center text-xl lg:text-2xl">
        ${category.icon}
      </div>
      <h3 class="text-sm lg:text-xl font-bold text-gray-900 mb-2">${category.name}</h3>
      <p class="text-gray-600 text-xs lg:text-sm">${category.description}</p>
    </div>
  `).join('');
  
  mainContent.innerHTML = `
    <section class="container mx-auto px-4 py-8">
      <div class="text-center mb-12">
        <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-4">ÿßŸÑÿ™ÿµŸÜŸäŸÅÿßÿ™</h1>
        <p class="text-gray-600 text-lg">ÿßÿÆÿ™ÿ± ÿßŸÑÿ™ÿµŸÜŸäŸÅ ÿßŸÑÿ∞Ÿä ÿ™ÿ±ŸäÿØ ÿßÿ≥ÿ™ŸÉÿ¥ÿßŸÅŸá</p>
      </div>
      
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 lg:gap-6">
        ${categoriesHTML}
      </div>
    </section>
  `;
}

// Funci√≥n para filtrar por tipo y navegar (funciona en ambas p√°ginas)
function filterByTypeAndNavigate(type) {
  console.log(`Filtering by type: ${type} and navigating to home`);
  
  // Detectar en qu√© p√°gina estamos
  const currentPage = window.location.pathname;
  
  if (currentPage.includes('sabio.html')) {
    // Si estamos en sabio.html, redirigir a index.html con el filtro aplicado
    localStorage.setItem('pendingFilter', type);
    window.location.href = 'index.html';
  } else {
    // Si estamos en index.html, aplicar el filtro directamente
    if (window.filterByType) {
      window.filterByType(type);
      if (window.navigateToPage) {
        window.navigateToPage('home');
      }
    } else {
      // Fallback: guardar filtro y recargar
      localStorage.setItem('pendingFilter', type);
      window.location.reload();
    }
  }
}

// Function to remove favorite with smooth animation
function removeFavoriteWithAnimation(itemId, itemName) {
  const cardElement = document.getElementById(`favorite-card-${itemId}`);
  
  if (cardElement) {
    // Add fade-out animation
    cardElement.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
    cardElement.style.opacity = '0';
    cardElement.style.transform = 'translateX(-20px)';
    
    // Wait for animation to complete, then remove from favorites
    setTimeout(() => {
      removeFavoriteFromPage(itemId, itemName);
    }, 300);
  } else {
    // Fallback if card element not found
    removeFavoriteFromPage(itemId, itemName);
  }
}

// ==================== SABIO SEARCH SYSTEM ====================

// Search state for sabio.html
const SabioSearchState = {
  searchQuery: '',
  searchResults: [],
  searchTotalItems: 0,
  searchTotalPages: 0,
  searchCurrentPage: 1,
  isSearching: false,
  searchDebounceTimer: null
};

// Initialize sabio search system
function initializeSabioSearch() {
  const searchInput = document.getElementById('searchInput');
  if (!searchInput) {
    console.warn('Search input not found in sabio.html');
    return;
  }
  
  // Add debounced search input handler
  searchInput.addEventListener('input', handleSabioSearchInput);
  
  // Add Enter key handler
  searchInput.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      clearTimeout(SabioSearchState.searchDebounceTimer);
      performSabioSearch();
    }
  });
  
  // Add search button handler if exists
  const searchBtn = document.querySelector('.search-btn');
  if (searchBtn) {
    searchBtn.addEventListener('click', () => {
      clearTimeout(SabioSearchState.searchDebounceTimer);
      performSabioSearch();
    });
  }
  
  console.log('üîç Sabio search system initialized');
}

// Debounced search input handler for sabio
function handleSabioSearchInput() {
  const searchInput = document.getElementById('searchInput');
  if (!searchInput) return;
  
  clearTimeout(SabioSearchState.searchDebounceTimer);
  SabioSearchState.searchDebounceTimer = setTimeout(() => {
    const query = searchInput.value.trim();
    if (query.length >= 2) {
      performSabioSearch(1, query);
    } else if (query.length === 0) {
      clearSabioSearch();
    }
  }, 300);
}

// Main sabio search function
async function performSabioSearch(page = 1, customQuery = null) {
  const searchInput = document.getElementById('searchInput');
  const searchQuery = customQuery || (searchInput ? searchInput.value.trim() : '');
  
  if (!searchQuery) {
    clearSabioSearch();
    return;
  }
  
  SabioSearchState.searchQuery = searchQuery;
  SabioSearchState.isSearching = true;
  
  console.log(`üîç Sabio search: "${searchQuery}" in category "${SabioPageState.activeCategory}" on page ${page}`);
  
  // Show loading state
  showSabioSearchLoading();
  
  try {
    // Get current sabio name for filtering - with fallback
    let currentSabio = SabioPageState.currentSabio;
    
    // If currentSabio is not set, try to get it from URL or localStorage
    if (!currentSabio) {
      const urlParams = new URLSearchParams(window.location.search);
      currentSabio = urlParams.get('sabio');
      
      if (!currentSabio) {
        currentSabio = localStorage.getItem('currentSabio');
      }
      
      // If still not found, try to extract from page title or use default
      if (!currentSabio) {
        const pageTitle = document.title;
        if (pageTitle.includes('ÿßŸÑÿ¥ŸäÿÆ')) {
          currentSabio = pageTitle.split(' - ')[0];
        } else {
          currentSabio = 'ÿßŸÑÿ¥ŸäÿÆ';
        }
      }
      
      // Update the state
      SabioPageState.currentSabio = currentSabio;
      console.log(`üîß Fixed missing sabio name: ${currentSabio}`);
    }
    
    console.log(`üë®‚Äçüè´ Searching in sabio: ${currentSabio}`);
    
    // Perform search within current sabio's content
    const searchResults = await searchInSabioContent(searchQuery, currentSabio, SabioPageState.activeCategory, page);
    
    // Validate search results
    if (!searchResults || typeof searchResults !== 'object') {
      throw new Error('Invalid search results format');
    }
    
    // Update search state
    SabioSearchState.searchResults = searchResults.data || [];
    SabioSearchState.searchTotalItems = searchResults.totalItems || 0;
    SabioSearchState.searchTotalPages = searchResults.totalPages || 1;
    SabioSearchState.searchCurrentPage = page;
    
    console.log(`‚úÖ Sabio search completed: ${SabioSearchState.searchTotalItems} results found`);
    
    // Display search results
    displaySabioSearchResults();
    
  } catch (error) {
    console.error('‚ùå Sabio search error:', error);
    const errorMessage = error.message || 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ®ÿ≠ÿ´. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.';
    showSabioSearchError(errorMessage);
  } finally {
    SabioSearchState.isSearching = false;
  }
}

// Search within sabio content with category filtering
async function searchInSabioContent(query, sabioName, category, page = 1) {
  const lowerQuery = query.toLowerCase();
  const itemsPerPage = 12;
  
  console.log(`üîç searchInSabioContent called with:`, { query, sabioName, category, page });
  
  // Get all sabio content data
  let allSabioData = [];
  
  // Try to get from current loaded data first
  if (SabioPageState.currentData && SabioPageState.currentData.length > 0) {
    allSabioData = SabioPageState.currentData;
    console.log(`üìÅ Using current loaded data: ${allSabioData.length} items`);
  } else {
    // Load all categories for comprehensive search
    console.log(`üìÅ Loading data for comprehensive search...`);
    try {
      // Check if loadSabioData function exists
      if (typeof loadSabioData !== 'function') {
        console.error('loadSabioData function not found');
        throw new Error('loadSabioData function not available');
      }
      
      const categories = ['ÿßŸÑŸÉŸÑ', 'ÿØÿ±Ÿàÿ≥', 'ŸÅÿ±ŸÇ', 'ŸÉÿ™ÿßÿ®'];
      for (const cat of categories) {
        if (cat === 'ÿßŸÑŸÉŸÑ') continue;
        console.log(`üìÇ Loading category: ${cat}`);
        const data = await loadSabioData(sabioName, cat);
        if (data && data.length > 0) {
          allSabioData = allSabioData.concat(data);
          console.log(`‚úÖ Loaded ${data.length} items from ${cat}`);
        }
      }
    } catch (error) {
      console.error('Error loading sabio data for search:', error);
      // Try to use any available data from SabioPageState
      if (SabioPageState.allData && SabioPageState.allData.length > 0) {
        allSabioData = SabioPageState.allData;
        console.log(`üîÑ Using fallback data: ${allSabioData.length} items`);
      } else {
        throw new Error('ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ŸÑŸÑÿ®ÿ≠ÿ´');
      }
    }
  }
  
  console.log(`üìÅ Total data available for search: ${allSabioData.length} items`);
  
  // Apply category filtering first if not "ÿßŸÑŸÉŸÑ"
  let categoryFilteredData = allSabioData;
  if (category && category !== 'ÿßŸÑŸÉŸÑ') {
    categoryFilteredData = allSabioData.filter(item => {
      const itemCategory = item.category || item.type || '';
      return itemCategory.toLowerCase().includes(category.toLowerCase()) || 
             category.toLowerCase().includes(itemCategory.toLowerCase());
    });
    
    console.log(`üìÇ Category filter "${category}": ${categoryFilteredData.length}/${allSabioData.length} items`);
  }
  
  // Apply text search filtering
  const filteredData = categoryFilteredData.filter(item => {
    // Search in title
    const titleMatch = item.title && item.title.toLowerCase().includes(lowerQuery);
    
    // Search in description
    const descMatch = item.description && item.description.toLowerCase().includes(lowerQuery);
    
    // Search in file name
    const fileMatch = item.file && item.file.toLowerCase().includes(lowerQuery);
    
    // Search in category
    const categoryMatch = item.category && item.category.toLowerCase().includes(lowerQuery);
    
    // Search in additional metadata
    const metaMatch = (
      (item.duration && item.duration.toLowerCase().includes(lowerQuery)) ||
      (item.size && item.size.toLowerCase().includes(lowerQuery)) ||
      (item.format && item.format.toLowerCase().includes(lowerQuery))
    );
    
    return titleMatch || descMatch || fileMatch || categoryMatch || metaMatch;
  });
  
  // Calculate pagination
  const totalItems = filteredData.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const startIndex = (page - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const paginatedData = filteredData.slice(startIndex, endIndex);
  
  return {
    data: paginatedData,
    totalItems: totalItems,
    totalPages: totalPages,
    currentPage: page
  };
}

// Display sabio search results
function displaySabioSearchResults() {
  const mainContent = document.getElementById('mainContent');
  if (!mainContent) return;
  
  const { searchResults, searchTotalItems, searchCurrentPage, searchTotalPages, searchQuery } = SabioSearchState;
  
  if (searchResults.length === 0) {
    showSabioSearchNoResults();
    return;
  }
  
  // Create search results HTML
  const resultsHTML = `
    <div class="search-results-container">
      <div class="container mx-auto px-4 py-8">
        <div class="search-results-header mb-6">
          <h3 class="text-2xl lg:text-3xl font-bold text-emerald-900 mb-2">ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ${SabioPageState.currentSabio}</h3>
          <p class="text-emerald-700 mb-2">ÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ${searchTotalItems} ŸÜÿ™Ÿäÿ¨ÿ© ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ "${searchQuery}"</p>
          <p class="text-sm text-gray-600">ÿßŸÑÿ™ÿµŸÜŸäŸÅ: ${SabioPageState.activeCategory}</p>
          <button onclick="clearSabioSearch()" class="mt-2 text-emerald-600 hover:text-emerald-800 text-sm">
            ‚Üê ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ${SabioPageState.currentSabio}
          </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          ${searchResults.map(item => renderSabioSearchCard(item)).join('')}
        </div>
        
        ${searchTotalPages > 1 ? renderSabioSearchPagination() : ''}
      </div>
    </div>
  `;
  
  mainContent.innerHTML = resultsHTML;
  
  // Update page state to search mode
  SabioPageState.isInSearchMode = true;
}

// Render individual search result card
function renderSabioSearchCard(item) {
  const isAudio = item.file && item.file.toLowerCase().includes('.mp3');
  const isPDF = item.file && item.file.toLowerCase().includes('.pdf');
  const isFavorited = localStorage.getItem('islamicFavorites')?.includes(item.id) || false;
  
  return `
    <div class="sabio-card bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 p-6">
      <div class="flex justify-between items-start mb-4">
        <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full ${
          isAudio ? 'bg-blue-100 text-blue-800' : 
          isPDF ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'
        }">
          ${item.category || (isAudio ? 'ÿµŸàÿ™Ÿä' : isPDF ? 'ŸÖŸÑŸÅ' : 'ŸÖÿ≠ÿ™ŸàŸâ')}
        </span>
        <button 
          class="favorite-btn ${isFavorited ? 'favorited' : ''}" 
          onclick="toggleSabioFavorite('${item.id}', '${item.title}', this)"
          title="${isFavorited ? 'ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©' : 'ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©'}"
        >
          <svg class="w-5 h-5" fill="${isFavorited ? 'currentColor' : 'none'}" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
          </svg>
        </button>
      </div>
      
      <h4 class="text-lg font-bold text-gray-900 mb-3 arabic-text leading-relaxed">
        ${highlightSearchTerms(item.title, SabioSearchState.searchQuery)}
      </h4>
      
      ${item.description ? `
        <p class="text-gray-600 mb-4 arabic-text leading-relaxed text-sm">
          ${highlightSearchTerms(item.description, SabioSearchState.searchQuery)}
        </p>
      ` : ''}
      
      <div class="flex justify-between items-center text-xs text-gray-500 mb-4">
        ${item.duration ? `<span>ÿßŸÑŸÖÿØÿ©: ${item.duration}</span>` : ''}
        ${item.size ? `<span>ÿßŸÑÿ≠ÿ¨ŸÖ: ${item.size}</span>` : ''}
      </div>
      
      <div class="flex gap-2">
        ${isAudio ? `
          <button 
            onclick="playAudioFromSabio('${item.file}', '${item.title}')"
            class="flex-1 bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 transition-colors text-sm"
          >
            ‚ñ∂ ÿ™ÿ¥ÿ∫ŸäŸÑ
          </button>
        ` : ''}
        
        ${item.file ? `
          <button 
            onclick="downloadSabioFile('${item.file}', '${item.title}')"
            class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors text-sm"
          >
            ÿ™ÿ≠ŸÖŸäŸÑ
          </button>
        ` : ''}
      </div>
    </div>
  `;
}

// Highlight search terms in text
function highlightSearchTerms(text, query) {
  if (!query || !text) return text;
  
  const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
  return text.replace(regex, '<mark class="bg-yellow-200 px-1 rounded">$1</mark>');
}

// Render search pagination
function renderSabioSearchPagination() {
  const { searchCurrentPage, searchTotalPages } = SabioSearchState;
  
  if (searchTotalPages <= 1) return '';
  
  const prevPage = searchCurrentPage > 1 ? searchCurrentPage - 1 : null;
  const nextPage = searchCurrentPage < searchTotalPages ? searchCurrentPage + 1 : null;
  
  return `
    <div class="flex justify-center items-center mt-8 gap-4">
      ${prevPage ? `
        <button 
          onclick="performSabioSearch(${prevPage})"
          class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors"
        >
          ‚Üê ÿßŸÑÿ≥ÿßÿ®ŸÇ
        </button>
      ` : ''}
      
      <span class="text-gray-600">
        ÿµŸÅÿ≠ÿ© ${searchCurrentPage} ŸÖŸÜ ${searchTotalPages}
      </span>
      
      ${nextPage ? `
        <button 
          onclick="performSabioSearch(${nextPage})"
          class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors"
        >
          ÿßŸÑÿ™ÿßŸÑŸä ‚Üí
        </button>
      ` : ''}
    </div>
  `;
}

// Show loading state for search
function showSabioSearchLoading() {
  const mainContent = document.getElementById('mainContent');
  if (!mainContent) return;
  
  mainContent.innerHTML = `
    <div class="loading-container">
      <div class="container mx-auto px-4 py-12 text-center">
        <div class="loading-spinner mb-4"></div>
        <p class="text-gray-600">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ${SabioPageState.currentSabio}...</p>
      </div>
    </div>
  `;
}

// Show no results state
function showSabioSearchNoResults() {
  const mainContent = document.getElementById('mainContent');
  if (!mainContent) return;
  
  mainContent.innerHTML = `
    <div class="no-results-container">
      <div class="container mx-auto px-4 py-12 text-center">
        <div class="text-4xl lg:text-6xl mb-6">üîç</div>
        <h2 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-4">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨</h2>
        <p class="text-gray-600 mb-8">
          ŸÑŸÖ ŸÜÿ™ŸÖŸÉŸÜ ŸÖŸÜ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÜÿ™ÿßÿ¶ÿ¨ ŸÑŸÑÿ®ÿ≠ÿ´ ÿπŸÜ "${SabioSearchState.searchQuery}" ŸÅŸä ${SabioPageState.currentSabio}
        </p>
        <div class="search-suggestions mb-8">
          <h3 class="text-lg font-semibold mb-4">ÿßŸÇÿ™ÿ±ÿßÿ≠ÿßÿ™ ŸÑŸÑÿ®ÿ≠ÿ´:</h3>
          <ul class="text-gray-600 space-y-2">
            <li>‚Ä¢ ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖŸÉÿ™Ÿàÿ®ÿ©</li>
            <li>‚Ä¢ ÿ¨ÿ±ÿ® ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÉŸÑŸÖÿßÿ™ ŸÖŸÅÿ™ÿßÿ≠Ÿäÿ© ŸÖÿÆÿ™ŸÑŸÅÿ©</li>
            <li>‚Ä¢ ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿ™ÿµŸÜŸäŸÅ "ÿßŸÑŸÉŸÑ" ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÜÿ™ÿßÿ¶ÿ¨ ÿ£Ÿàÿ≥ÿπ</li>
            <li>‚Ä¢ ÿ¨ÿ±ÿ® ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä ÿπŸÑŸÖÿßÿ° ÿ¢ÿÆÿ±ŸäŸÜ</li>
          </ul>
        </div>
        <button 
          onclick="clearSabioSearch()" 
          class="bg-emerald-600 text-white px-6 py-3 rounded-lg hover:bg-emerald-700 transition-colors"
        >
          ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ${SabioPageState.currentSabio}
        </button>
      </div>
    </div>
  `;
}

// Show search error
function showSabioSearchError(message) {
  const mainContent = document.getElementById('mainContent');
  if (!mainContent) return;
  
  mainContent.innerHTML = `
    <div class="error-container">
      <div class="container mx-auto px-4 py-12 text-center">
        <div class="text-4xl lg:text-6xl mb-6">‚ö†Ô∏è</div>
        <h2 class="text-2xl lg:text-3xl font-bold text-red-600 mb-4">ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ®ÿ≠ÿ´</h2>
        <p class="text-gray-600 mb-8">${message}</p>
        <div class="flex gap-4 justify-center">
          <button 
            onclick="performSabioSearch()" 
            class="bg-emerald-600 text-white px-6 py-3 rounded-lg hover:bg-emerald-700 transition-colors"
          >
            ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©
          </button>
          <button 
            onclick="clearSabioSearch()" 
            class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors"
          >
            ÿßŸÑÿπŸàÿØÿ© ÿ•ŸÑŸâ ${SabioPageState.currentSabio || 'ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©'}
          </button>
        </div>
      </div>
    </div>
  `;
}

// Clear sabio search and return to normal view
function clearSabioSearch() {
  const searchInput = document.getElementById('searchInput');
  if (searchInput) {
    searchInput.value = '';
  }
  
  // Reset search state
  SabioSearchState.searchQuery = '';
  SabioSearchState.searchResults = [];
  SabioSearchState.searchTotalItems = 0;
  SabioSearchState.searchTotalPages = 0;
  SabioSearchState.searchCurrentPage = 1;
  SabioSearchState.isSearching = false;
  
  // Clear search timer
  clearTimeout(SabioSearchState.searchDebounceTimer);
  
  // Return to normal sabio view
  SabioPageState.isInSearchMode = false;
  
  // Reload current category content
  loadCategoryContentInternal(SabioPageState.currentSabio, SabioPageState.activeCategory);
  
  console.log('üîç Sabio search cleared, returned to normal view');
}

// Make search functions globally available
window.performSabioSearch = performSabioSearch;
window.clearSabioSearch = clearSabioSearch;
window.highlightSearchTerms = highlightSearchTerms;

// Function to remove favorite from favorites page and re-render
function removeFavoriteFromPage(itemId, itemName) {
  // Get the full item data from localStorage
  const favoritesData = JSON.parse(localStorage.getItem('islamicFavoritesData') || '{}');
  const item = favoritesData[itemId.toString()];
  
  if (!item) {
    console.error('Item not found in favorites data:', itemId);
    return;
  }
  
  // Use the global toggleFavorite function if available
  if (typeof window.toggleFavorite === 'function') {
    // Call the global toggle function
    window.toggleFavorite(itemId, item);
    
    // Re-render the favorites page after a short delay to allow the toggle to complete
    setTimeout(() => {
      renderFavoritesPage();
    }, 100);
  } else {
    // Fallback: manually remove from localStorage and re-render
    const favorites = JSON.parse(localStorage.getItem('islamicFavorites') || '[]');
    
    const idStr = itemId.toString();
    const index = favorites.indexOf(idStr);
    
    if (index !== -1) {
      // Remove from favorites
      const newFavorites = favorites.filter((_, i) => i !== index);
      const { [idStr]: removed, ...newFavoritesData } = favoritesData;
      
      // Update localStorage
      localStorage.setItem('islamicFavorites', JSON.stringify(newFavorites));
      localStorage.setItem('islamicFavoritesData', JSON.stringify(newFavoritesData));
      
      // Show notification
      const message = `ÿ™ŸÖ ÿ≠ÿ∞ŸÅ "${itemName}" ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©`;
      
      if (typeof window.showNotification === 'function') {
        window.showNotification(message, 'info');
      } else if (typeof showSabioNotification === 'function') {
        showSabioNotification(message, 'info');
      }
      
      // Sync favorites counter globally
      if (typeof window.syncFavoritesCounter === 'function') {
        window.syncFavoritesCounter();
      }
      
      // Re-render the favorites page
      renderFavoritesPage();
    }
  }
}

// Test function to debug favorites
function testFavorites() {
  console.log('=== TESTING FAVORITES ===');
  const favorites = JSON.parse(localStorage.getItem('islamicFavorites') || '[]');
  const favoritesData = JSON.parse(localStorage.getItem('islamicFavoritesData') || '{}');
  console.log('Raw favorites:', favorites);
  console.log('Raw favoritesData:', favoritesData);
  console.log('AppState exists:', !!window.AppState);
  if (window.AppState) {
    console.log('AppState.favorites:', window.AppState.favorites);
    console.log('AppState.favoritesData:', window.AppState.favoritesData);
  }
  console.log('=== END TEST ===');
}

// Make test function globally available
window.testFavorites = testFavorites;

// Function to render favorite cards directly
function renderFavoriteCards(items) {
  console.log('üé® renderFavoriteCards called with', items.length, 'items');
  const mainContent = document.getElementById('mainContent');
  if (!mainContent) {
    console.log('‚ùå mainContent not found in renderFavoriteCards');
    return;
  }
  
  let favoriteCardsHTML = '';
  
  // Use global renderContentCard if available
  if (window.renderContentCard && typeof window.renderContentCard === 'function') {
    console.log('‚úÖ Using window.renderContentCard for direct rendering');
    favoriteCardsHTML = items.map(item => window.renderContentCard(item)).join('');
  } else {
    console.log('‚ö†Ô∏è window.renderContentCard not available, using fallback');
    // Fallback rendering
    favoriteCardsHTML = items.map(item => {
      const escapeHtml = (text) => {
        if (!text) return '';
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;")
          .replace(/\n/g, "<br>");
      };
      
      const typeClass = `type-${item.type}`;
      const typeName = item.type === 'audios' ? 'ÿµŸàÿ™Ÿä' : (item.type === 'books' ? 'ŸÉÿ™ÿßÿ®' : (item.type === 'fatwa' ? 'ŸÅÿ™ŸàŸâ' : 'ŸÖÿ≠ÿ™ŸàŸâ'));
      
      return `
        <div class="card fade-in" id="favorite-card-${item.id}">
          <div class="flex justify-between items-start mb-3">
            <span class="content-type-badge ${typeClass}">${typeName}</span>
            <button onclick="removeFavoriteWithAnimation('${item.id}', '${escapeHtml(item.title || item.name || 'ÿßŸÑÿπŸÜÿµÿ±')}')" class="btn-icon favorite-btn favorited" title="ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©" style="color: #ef4444;">
              <svg class="w-5 h-5" fill="currentColor" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
              </svg>
            </button>
          </div>
          <h4 class="text-lg font-bold text-gray-900 mb-2 arabic-text leading-relaxed">${escapeHtml(item.title || item.name || 'ÿ®ÿØŸàŸÜ ÿπŸÜŸàÿßŸÜ')}</h4>
          <p class="text-gray-600 mb-4 arabic-text leading-relaxed line-clamp-3 text-sm lg:text-base">${escapeHtml(item.description || '')}</p>
          ${item.author ? `<p class="text-sm text-emerald-600 font-semibold mb-3">${escapeHtml(item.author)}</p>` : ''}
        </div>
      `;
    }).join('');
  }
  
  // Render the cards directly without any header
  mainContent.innerHTML = `
    <section class="container mx-auto px-4 py-8 lg:py-12">
      <div class="content-grid">
        ${favoriteCardsHTML}
      </div>
    </section>
  `;
  
  console.log('‚úÖ Favorite cards rendered successfully');
}

// Renderizar p√°gina de favoritos (id√©ntico a index.html)
function renderFavoritesPage() {
  console.log('üöÄ renderFavoritesPage called');
  const mainContent = document.getElementById('mainContent');
  if (!mainContent) {
    console.log('‚ùå mainContent not found');
    return;
  }
  
  // Limpiar contenido previo
  mainContent.innerHTML = '';
  
  // Create minimal AppState if it doesn't exist (for compatibility with app.js functions)
  if (!window.AppState) {
    console.log('üîß Creating minimal AppState for favorites compatibility');
    window.AppState = {
      favorites: [],
      favoritesData: {},
      activeNav: 'favorites'
    };
  }
  
  // Force refresh AppState favorites with localStorage data
  const storedFavorites = JSON.parse(localStorage.getItem('islamicFavorites') || '[]');
  const storedFavoritesData = JSON.parse(localStorage.getItem('islamicFavoritesData') || '{}');
  window.AppState.favorites = storedFavorites;
  window.AppState.favoritesData = storedFavoritesData;
  window.AppState.activeNav = 'favorites';
  
  console.log('üîÑ Refreshed AppState with localStorage data');
  console.log('üî• DEBUG: SabioPageState.activeNav =', SabioPageState.activeNav);
  console.log('üî• DEBUG: AppState.activeNav =', window.AppState.activeNav);
  
  // Obtener favoritos desde localStorage (id√©ntico a index.html)
  const favorites = JSON.parse(localStorage.getItem('islamicFavorites') || '[]');
  const favoritesData = JSON.parse(localStorage.getItem('islamicFavoritesData') || '{}');
  const favoriteItems = favorites.map(id => favoritesData[id]).filter(Boolean);
  
  console.log('DEBUG: Favorites data:');
  console.log('- favorites array:', favorites);
  console.log('- favorites array length:', favorites.length);
  console.log('- favoritesData object:', favoritesData);
  console.log('- favoritesData keys:', Object.keys(favoritesData));
  
  // Debug the mapping process
  console.log('DEBUG: Mapping process:');
  favorites.forEach((id, index) => {
    console.log(`- favorites[${index}] = "${id}" -> favoritesData["${id}"] =`, favoritesData[id]);
  });
  
  console.log('- favoriteItems after mapping:', favoriteItems);
  console.log(`Rendering favorites page with ${favoriteItems.length} items`);
  
  // Force check: if we have favorites in localStorage but favoriteItems is empty, there's a mapping issue
  if (favorites.length > 0 && favoriteItems.length === 0) {
    console.log('‚ö†Ô∏è MAPPING ISSUE: Have favorites but favoriteItems is empty');
    console.log('Attempting to fix by using raw favorites data...');
    
    // Try to reconstruct favoriteItems from available data
    const reconstructedItems = [];
    favorites.forEach(id => {
      if (favoritesData[id]) {
        reconstructedItems.push(favoritesData[id]);
      } else {
        console.log(`Missing data for favorite ID: ${id}`);
      }
    });
    
    if (reconstructedItems.length > 0) {
      console.log('‚úÖ Successfully reconstructed favorites:', reconstructedItems);
      // Force render with reconstructed items
      renderFavoriteCards(reconstructedItems);
      return;
    }
  }
  
  if (favoriteItems.length === 0) {
    console.log('DEBUG: Showing empty state because favoriteItems.length === 0');
    // Mostrar mensaje cuando no hay favoritos (id√©ntico a index.html)
    mainContent.innerHTML = `
      <section class="container mx-auto px-4 py-12 text-center">
        <div class="max-w-md mx-auto">
          <div class="text-4xl lg:text-6xl mb-6">ŸÖŸÅÿ∂ŸÑÿ©</div>
          <h2 class="text-2xl lg:text-3xl font-bold text-gray-900 mb-4">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÅÿ∂ŸÑÿ©</h2>
          <p class="text-gray-600 mb-8 text-sm lg:text-base">ŸÑŸÖ ÿ™ŸÇŸÖ ÿ®ÿ•ÿ∂ÿßŸÅÿ© ÿ£Ÿä ŸÖÿ≠ÿ™ŸàŸâ ÿ•ŸÑŸâ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ© ÿ®ÿπÿØ</p>
          <button onclick="renderSabioContent()" class="btn btn-primary">
            ÿßŸÑÿπŸàÿØÿ© ŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿ¥ŸäÿÆ
          </button>
        </div>
      </section>
    `;
  } else {
    console.log('DEBUG: Found favorites, proceeding to render');
    console.log('DEBUG: Rendering favorites with items:', favoriteItems);
    
    // Try to use AppState favorites if available (like index.html does)
    let finalFavoriteItems = favoriteItems;
    if (window.AppState && window.AppState.favorites && window.AppState.favoritesData) {
      console.log('DEBUG: Using AppState favorites data');
      const appStateFavorites = window.AppState.favorites;
      const appStateFavoritesData = window.AppState.favoritesData;
      finalFavoriteItems = appStateFavorites.map(id => appStateFavoritesData[id]).filter(Boolean);
      console.log('DEBUG: AppState favoriteItems:', finalFavoriteItems);
    }
    
    // Use the dedicated renderFavoriteCards function
    renderFavoriteCards(finalFavoriteItems);
    return; // Exit here after rendering
  }
}

// Function to clear navigation state (same as app.js)
function clearNavigationState() {
  localStorage.removeItem('currentNavigationState');
  console.log('üóëÔ∏è Sabio navigation state cleared');
}

// Hacer funciones disponibles globalmente para compatibilidad
window.loadCategoryContent = sabioLoadCategoryContent; // Usar la funci√≥n espec√≠fica de sabio.js
window.sabioLoadCategoryContent = sabioLoadCategoryContent; // Tambi√©n disponible con nombre espec√≠fico
window.handleFileClick = handleFileClick;
window.toggleSabioFavorite = toggleSabioFavorite;
window.isSabioItemFavorited = isSabioItemFavorited;
window.formatFileSize = formatFileSize;
window.navigateToPage = navigateToPage; // Override app.js version for sabio.html
window.clearNavigationState = clearNavigationState;
window.filterByTypeAndNavigate = filterByTypeAndNavigate; // Funci√≥n para filtrar y navegar
window.renderCategoriesPage = renderCategoriesPage; // Unified categories page for both index.html and sabio.html
window.removeFavoriteWithAnimation = removeFavoriteWithAnimation; // Function to remove favorites with animation
window.removeFavoriteFromPage = removeFavoriteFromPage; // Function to remove favorites from page
window.syncAppStateWithSabio = syncAppStateWithSabio; // Function to sync AppState with sabio data
window.updateSabioStatsDisplay = updateSabioStatsDisplay; // Function to update sabio stats display

// Funci√≥n adicional para limpiar interferencias de app.js
function cleanupAppJsInterference() {
  // Limpiar cualquier contenido residual de app.js
  const mainContent = document.getElementById('mainContent');
  if (mainContent && mainContent.innerHTML.includes('home-stats')) {
    console.log('Cleaning up app.js interference...');
    mainContent.innerHTML = '';
  }
}

// Observador para detectar cambios no deseados en el DOM
function setupDOMProtection() {
  const mainContent = document.getElementById('mainContent');
  if (!mainContent) return;
  
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (window.SABIO_PAGE_ACTIVE && mutation.type === 'childList') {
        // Si detectamos contenido de app.js, lo limpiamos
        const addedNodes = Array.from(mutation.addedNodes);
        addedNodes.forEach(node => {
          if (node.nodeType === 1 && (node.classList?.contains('home-stats') || node.querySelector?.('.home-stats'))) {
            console.log('Preventing app.js content injection');
            node.remove();
          }
        });
      }
    });
  });
  
  observer.observe(mainContent, {
    childList: true,
    subtree: true
  });
}

// Configurar event listeners para botones de categor√≠a DESPU√âS del renderizado
function setupCategoryEventListeners() {
  console.log('üîß Setting up category event listeners...');
  
  // Buscar todos los botones de categor√≠a
  const categoryButtons = document.querySelectorAll('.category-btn');
  console.log(`Found ${categoryButtons.length} category buttons`);
  
  categoryButtons.forEach((button, index) => {
    const category = button.dataset.category;
    console.log(`üîò Setting up listener for button ${index + 1}: "${category}"`);
    
    // Remover listeners previos para evitar duplicados
    const newButton = button.cloneNode(true);
    button.parentNode.replaceChild(newButton, button);
    
    // Agregar nuevo listener
    newButton.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation(); // IMPORTANTE: Prevenir otros event listeners
      
      console.log(`üíÜ Category button clicked: "${category}"`);
      console.log('üö´ Preventing app.js event listeners from firing');
      
      // Actualizar botones visualmente inmediatamente
      document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline');
      });
      newButton.classList.remove('btn-outline');
      newButton.classList.add('btn-primary');
      
      try {
        console.log(`üöÄ About to call SABIO loadCategoryContent("${category}")`);
        // Llamar EXPL√çCITAMENTE a la funci√≥n de sabio.js (NO la de app.js)
        await sabioLoadCategoryContent(category);
        console.log(`‚úÖ SABIO loadCategoryContent("${category}") called successfully`);
      } catch (error) {
        console.error(`üí• Error calling SABIO loadCategoryContent("${category}"):`, error);
        console.error('Stack trace:', error.stack);
      }
      
      return false; // Prevenir cualquier propagaci√≥n adicional
    }, true); // Usar capture phase para ejecutar ANTES que app.js
  });
  
  if (categoryButtons.length === 0) {
    console.warn('‚ö†Ô∏è No category buttons found! Buttons may not be rendered yet.');
    // Intentar nuevamente despu√©s de un breve retraso
    setTimeout(setupCategoryEventListeners, 500);
  } else {
    console.log(`‚úÖ Successfully set up ${categoryButtons.length} category event listeners`);
  }
}

// Override toggleFavoriteById in sabio.html favorites page to use animation
function createSabioToggleFavoriteById() {
  const originalToggleFavoriteById = window.toggleFavoriteById;
  
  return function(id) {
    // Check if we're in favorites page in sabio.html
    if (window.location.pathname.includes('sabio.html') && 
        SabioPageState.activeNav === 'favorites') {
      
      // Get item name for notification
      const favoritesData = JSON.parse(localStorage.getItem('islamicFavoritesData') || '{}');
      const item = favoritesData[id.toString()];
      const itemName = item ? (item.title || item.name || 'ÿßŸÑÿπŸÜÿµÿ±') : 'ÿßŸÑÿπŸÜÿµÿ±';
      
      // Use our animated removal function
      removeFavoriteWithAnimation(id, itemName);
    } else {
      // Use original function for other cases
      if (originalToggleFavoriteById) {
        originalToggleFavoriteById(id);
      }
    }
  };
}

// CRITICAL: Override app.js navigateToPage function after app.js loads (only in sabio.html)
// This ensures sabio.html uses the correct navigation function with NO state saving for favorites/categories
setTimeout(() => {
  // Only override functions in sabio.html
  if (window.location.pathname.includes('sabio.html')) {
    console.log('üöÄ Sabio.js: Overriding functions in sabio.html');
    
    // Override toggleFavoriteById to use animation in favorites page
    if (window.toggleFavoriteById) {
      window.toggleFavoriteById = createSabioToggleFavoriteById();
      console.log('‚úÖ Overrode toggleFavoriteById with animated version for sabio.html');
    }
    
    // Store original function if it exists
    const originalNavigateToPage = window.navigateToPage;
    
    // Override with sabio-specific version that NEVER saves state for favorites/categories
    window.navigateToPage = function(page) {
      console.log(`üß≠ Sabio.js navigateToPage OVERRIDE called with: "${page}"`);
      
      // Cerrar men√∫ m√≥vil si est√° abierto
      if (window.closeMobileMenu) {
        window.closeMobileMenu();
      }
      
      // IMPORTANTE: Guardar estado de navegaci√≥n para todas las p√°ginas (igual que index.html)
      const simpleState = {
        page: page,
        timestamp: Date.now(),
        pageType: 'sabio'
      };
      
      localStorage.setItem('sabioNavState', JSON.stringify(simpleState));
      console.log(`üîÑ Sabio navigation state saved: ${page}`);
      
      // Actualizar estados de navegaci√≥n activa
      document.querySelectorAll('.nav-link, .mobile-nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.dataset.page === page) {
          link.classList.add('active');
        }
      });
      
      // Manejar diferentes p√°ginas
      switch (page) {
        case 'categories':
          console.log('üè∑Ô∏è Showing categories page in sabio.html');
          SabioPageState.activeNav = 'categories';
          renderCategoriesPage();
          // Reinitialize mega menu after rendering categories
          setTimeout(() => {
            if (window.initializeMegaMenu) {
              window.initializeMegaMenu();
            }
          }, 100);
          break;
        case 'favorites':
          console.log('üî• Showing favorites page in sabio.html');
          SabioPageState.activeNav = 'favorites';
          console.log('üî• Set SabioPageState.activeNav to:', SabioPageState.activeNav);
          renderFavoritesPage();
          // Reinitialize mega menu after rendering favorites
          setTimeout(() => {
            if (window.initializeMegaMenu) {
              window.initializeMegaMenu();
            }
          }, 100);
          break;
        case 'home':
          console.log('üè† Returning to sabio home page');
          SabioPageState.activeNav = 'home';
          clearNavigationState();
          loadCategoryContentInternal('all');
          break;
        default:
          console.log(`‚ö†Ô∏è Unknown page: ${page}, defaulting to home`);
          SabioPageState.activeNav = 'home';
          clearNavigationState();
          loadCategoryContentInternal('all');
      }
    };
    console.log('‚úÖ Sabio.js navigateToPage function override installed');
  } else {
    console.log('üöÄ Sabio.js: Not overriding functions in index.html');
  }
}, 500); // Increased delay to ensure app.js loads first